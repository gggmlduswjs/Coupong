# 마진 계산기

#feature #margin #calculator

**상태:** ✅ 완료
**구현 파일:** `analyzers/margin_calculator.py`, `app/models/publisher.py`

---

## 개요

출판사별 공급률(매입율)에 따라 도서정가제 기반 마진을 자동 계산하고, 배송 정책(무료/유료/묶음필수)을 결정한다.

## 계산 공식

```
판매가     = 정가 × 0.9           (도서정가제)
공급원가   = 정가 × 공급률
쿠팡수수료 = 판매가 × 0.11        (쿠팡 11%)
권당마진   = 판매가 - 공급원가 - 쿠팡수수료
순마진     = 권당마진 - 2,000원    (배송비)
```

## 배송 정책 결정

| 순마진 | 정책 | 설명 |
|--------|------|------|
| >= 2,000원 | `free` | 무료배송 (단권 업로드) |
| >= 0원 | `paid` | 유료배송 (단권 업로드) |
| < 0원 | `bundle_required` | 묶음 필수 |

## 수익성 등급 (MarginCalculator)

| 등급 | 순마진 조건 | 권장 |
|------|-------------|------|
| excellent | >= 5,000원 | 강력 권장 |
| good | >= 2,000원 | 권장 |
| acceptable | >= 0원 | 가능 |
| poor | < 0원 | 묶음 필수 |

## 핵심 메서드

### `Publisher.calculate_margin(list_price)`
- 위치: `app/models/publisher.py`
- 단일 도서의 마진 계산, dict 반환

### `MarginCalculator.analyze_book(book, publisher)`
- 위치: `analyzers/margin_calculator.py`
- 수익성 등급 + 배송정책 + 추천 메시지 포함한 상세 분석

### `MarginCalculator.batch_analyze_books(book_ids)`
- 위치: `analyzers/margin_calculator.py`
- 다수 도서 일괄 분석, 카테고리별 수익성/배송정책 통계

## 매입율 분포 (24개 출판사)

| 매입율 | 공급률 | 출판사 수 | 대표 |
|--------|--------|-----------|------|
| 40% | 0.60 | 4개 | 마린북스, 아카데미소프트 |
| 55% | 0.45 | 2개 | 크라운, 영진 |
| 60% | 0.40 | 5개 | 길벗, 사회평론, 이퓨쳐 |
| 65% | 0.35 | 10개 | 개념원리, 비상교육, 한빛미디어 |
| 67% | 0.33 | 1개 | 동아 |
| 70% | 0.30 | 1개 | 좋은책신사고 |
| 73% | 0.27 | 1개 | 한국교육방송공사(EBS) |

## 계산 예시

```
정가 15,000원 / 매입율 65% (공급률 0.35)

판매가     = 15,000 × 0.9 = 13,500원
공급원가   = 15,000 × 0.35 = 5,250원
쿠팡수수료 = 13,500 × 0.11 = 1,485원
권당마진   = 13,500 - 5,250 - 1,485 = 6,765원
순마진     = 6,765 - 2,000 = 4,765원 → 등급: good, 무료배송
```

## 관련 문서

- [[묶음-SKU-생성기]] - 순마진 < 0 도서의 묶음 처리
- [[Database-Schema-V2]] - products 테이블 구조
- [[알라딘-API-크롤러]] - 정가 데이터 수집원
