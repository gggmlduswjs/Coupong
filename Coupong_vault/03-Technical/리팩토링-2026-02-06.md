# 코드 리팩토링 (2026-02-06)

#refactoring #security #stability

**상태:** ✅ 완료
**커밋:** `10fe3a9`

---

## 개요

보안(P0) → 안정성(P1) → 유지보수성(P2) → 테스트(P3) 순서로 4단계 리팩토링 완료.
SQL 인젝션 취약점 수정, 재시도 로직 추가, 입력 검증 모듈화, 테스트 코드 34개 작성.

---

## P0: 보안 (Critical)

### 1. SQL 인젝션 취약점 수정

**문제:** f-string으로 SQL 쿼리 구성 → SQL 인젝션 가능

```python
# Before (취약)
sql += f" AND account_name = '{account_name}'"

# After (안전)
sql += " AND account_name = :account_name"
params["account_name"] = account_name
```

**수정 파일:**
| 파일 | 라인 | 변경 내용 |
|------|------|----------|
| `scripts/sync_revenue.py` | 100-101 | 파라미터 바인딩 |
| `scripts/sync_inventory.py` | 112-113 | 파라미터 바인딩 |
| `scripts/sync_settlement.py` | 100-101 | 파라미터 바인딩 |

### 2. 공통 모듈 생성

**신규 파일:** `app/services/wing_sync_base.py`

```python
from app.services.wing_sync_base import get_accounts, create_wing_client

# SQL 인젝션 방지된 계정 조회
accounts = get_accounts(engine, account_name="007-book")

# 공통 클라이언트 생성
client = create_wing_client(account)
```

### 3. 자동 실행 안전장치

**수정 파일:** `scripts/auto_crawl.py`

```bash
# --confirm 없이 데몬 실행 시 5초 대기 + 경고
python scripts/auto_crawl.py           # 5초 대기 후 시작
python scripts/auto_crawl.py --confirm  # 즉시 시작
python scripts/auto_crawl.py --max-items 100  # 최대 처리량 제한
```

---

## P1: 안정성

### 1. 트랜잭션 원자성 보장

**신규 파일:** `app/services/transaction_manager.py`

```python
from app.services.transaction_manager import atomic_operation, BatchProcessor

# 원자적 작업 (실패 시 자동 롤백)
with atomic_operation(engine) as conn:
    conn.execute(text("INSERT ..."), params)
    conn.execute(text("UPDATE ..."), params)
# 자동 커밋 또는 롤백

# 배치 처리 + 에러 수집
processor = BatchProcessor(engine, batch_size=50)
results = processor.process_batch(items, process_func)
# {"success": [...], "failed": [...], "errors": [...]}
```

### 2. API 재시도 로직

**신규 파일:** `app/utils/retry.py`

```python
from app.utils.retry import retry_on_exception

@retry_on_exception(max_attempts=3, base_delay=1.0)
def api_call():
    return requests.get(url)
```

**수정 파일:** `app/api/coupang_wing_client.py`

- 지수 백오프 재시도 (1초 → 2초 → 4초)
- 재시도 가능 상태 코드: 429, 500, 502, 503, 504
- `_parse_response()`: HTTP 200에서도 에러 체크

### 3. SQLite 마이그레이션 헬퍼

**신규 파일:** `app/services/db_migration.py`

```python
from app.services.db_migration import SQLiteMigrator

migrator = SQLiteMigrator(engine)
migrator.add_columns_if_missing("accounts", {
    "vendor_id": "VARCHAR(20)",
    "wing_api_enabled": "BOOLEAN DEFAULT 0",
})
```

### 4. 동기화 로거

**신규 파일:** `app/utils/sync_logger.py`

```python
from app.utils.sync_logger import SyncLogger

logger = SyncLogger("revenue_sync")
logger.log_success(account="007-book", count=100)
logger.log_failure(account="007-bm", error="API 오류", item_id=123)
report = logger.end_sync()  # JSON 리포트 저장
```

---

## P2: 유지보수성

### 1. 입력 검증 모듈

**신규 파일:** `app/utils/validators.py`

```python
from app.utils.validators import BookValidator, ProductValidator

# ISBN 검증
validator = BookValidator()
error = validator.validate_isbn("9788956746425")  # None = 유효

# 가격 검증
error = validator.validate_price(15000)  # None = 유효

# 상품 업로드 전 검증
validator = ProductValidator()
is_valid, errors = validator.validate_for_upload(product_data)
```

### 2. 예외 처리 개선

```python
# Before (광범위)
except Exception as e:
    logger.error(f"오류: {e}")

# After (구체적)
except IntegrityError:
    logger.debug(f"중복 스킵: order_id={order_id}")
except SQLAlchemyError as e:
    logger.warning(f"DB 오류: {e}")
except (ValueError, TypeError) as e:
    logger.warning(f"데이터 변환 오류: {e}")
```

### 3. 설정 상수 통합

**수정 파일:** `app/constants.py`

```python
SYNC_CONFIG = {
    "batch_size": 50,
    "retry_max_attempts": 3,
    "retry_base_delay": 1.0,
}

TIMEOUT_CONFIG = {
    "api_request": 30,
    "db_busy": 30000,
}

AUTO_CRAWL_CONFIG = {
    "crawl_hour": 3,
    "max_per_publisher": 50,
    "max_items_safety": 200,
}
```

---

## P3: 테스트 및 버그 수정

### 1. 테스트 코드 (34개)

**신규 파일:**
- `tests/test_validators.py` - 23개 테스트
- `tests/test_sync_base.py` - 11개 테스트

```bash
pytest tests/ -v
# 34 passed, 2 warnings in 0.98s
```

### 2. 연도 추출 버그 수정

**수정 파일:** `app/models/book.py`

```python
# Before: "2학년" → 2002년 (버그)
# After: "2학년" → None (정상)

# 명시적 연도 표현만 인식
"24년도" → 2024  ✅
"24학년도" → 2024  ✅
"'24" → 2024  ✅
"2학년" → None  ✅ (학년은 연도 아님)
```

### 3. 카테고리 캐싱 개선

**수정 파일:** `uploaders/coupang_api_uploader.py`

```python
# Before: 인메모리 캐시 (세션 종료 시 소멸)
# After: 파일 기반 영구 캐시

# 캐시 위치: cache/category_cache.json
```

---

## 신규 생성 파일 (9개)

| 파일 | 용도 |
|------|------|
| `app/services/wing_sync_base.py` | SQL 인젝션 방지, 공통 계정 조회 |
| `app/services/transaction_manager.py` | 트랜잭션 원자성, 배치 처리 |
| `app/services/db_migration.py` | SQLite 마이그레이션 헬퍼 |
| `app/utils/retry.py` | 지수 백오프 재시도 데코레이터 |
| `app/utils/sync_logger.py` | 동기화 로거 + JSON 리포트 |
| `app/utils/validators.py` | ISBN/가격/상품 검증 |
| `tests/test_validators.py` | 검증 로직 테스트 (23개) |
| `tests/test_sync_base.py` | SQL 인젝션 방지 테스트 (11개) |
| `cache/` | 카테고리 캐시 디렉토리 |

---

## 주요 수정 파일 (12개)

| 파일 | 변경 내용 |
|------|----------|
| `scripts/sync_revenue.py` | 공통 모듈 사용, 예외 처리 개선 |
| `scripts/sync_inventory.py` | 공통 모듈 사용 |
| `scripts/sync_settlement.py` | 공통 모듈 사용 |
| `scripts/sync_coupang_products.py` | SQLiteMigrator 적용 |
| `scripts/auto_crawl.py` | --confirm, --max-items 플래그 |
| `app/api/coupang_wing_client.py` | 재시도 로직, 응답 파싱 강화 |
| `app/constants.py` | SYNC_CONFIG 등 설정 추가 |
| `app/models/book.py` | extract_year 버그 수정 |
| `app/services/__init__.py` | 신규 모듈 export |
| `uploaders/coupang_api_uploader.py` | 파일 기반 카테고리 캐시 |
| `uploaders/playwright_uploader.py` | List import 추가 |

---

## 관련 문서

- [[코드-리뷰-자동화-시스템]] - 전체 시스템 분석
- [[가격-수정-내역-2026-02-06]] - 가격 오류 수정 기록
