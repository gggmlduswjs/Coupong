# 시스템 아키텍처

#technical #architecture #design

**마지막 업데이트:** 2026-02-05

---

## 전체 구조

```
┌─────────────────────────────────────────────────────────────┐
│                  쿠팡 도서 자동화 시스템                      │
│              Phase 1 완료 / Phase 2 진행중                   │
└─────────────────────────────────────────────────────────────┘

┌──────────────────┐     ┌──────────────────┐
│   Data Source    │     │  Coupang WING    │
│  (Aladin API)    │     │  (Open API)      │
└────────┬─────────┘     └────────┬─────────┘
         │ HTTP                    │ HMAC-SHA256
         ↓                        ↓
┌─────────────────────────────────────────────────────────────┐
│                      CRAWLER LAYER                           │
├─────────────────────────────────────────────────────────────┤
│  AladinAPICrawler          CoupangWingClient                │
│  - search_by_keyword()     - list_products()                │
│  - 연도 추출               - get_product()                  │
│  - 시리즈 정규화           - recommend_category()           │
│                            - get_ordersheets()              │
└────────┬───────────────────────────┬────────────────────────┘
         │ Raw Book Data             │ Existing Product Data
         ↓                          ↓
┌─────────────────────────────────────────────────────────────┐
│                       MODEL LAYER                            │
├─────────────────────────────────────────────────────────────┤
│  SQLAlchemy Models:                                          │
│  - Publisher (마진율, 공급률)                                 │
│  - Book (ISBN, 제목, 가격, 연도, 시리즈)                      │
│  - Product (단권 상품, 마진 정보)                             │
│  - BundleSKU (묶음 상품)                                     │
│  - Listing (업로드 현황, 중복 체크)                           │
│  - Account (5개 계정 + WING API 인증 정보)                   │
└────────┬────────────────────────────────────────────────────┘
         │ Persisted Data
         ↓
┌─────────────────────────────────────────────────────────────┐
│                      DATABASE LAYER                          │
├─────────────────────────────────────────────────────────────┤
│  SQLite (coupang_auto.db)                                    │
│  - 8개 테이블 + ALTER TABLE 마이그레이션                      │
│  - UNIQUE 제약조건 (중복 방지)                                │
│  - 외래키 관계                                                │
└────────┬────────────────────────────────────────────────────┘
         │ Query Results
         ↓
┌─────────────────────────────────────────────────────────────┐
│                     ANALYZER LAYER                           │
├─────────────────────────────────────────────────────────────┤
│  MarginCalculator              BundleGenerator               │
│  - analyze_book()              - find_bundleable_books()     │
│  - calculate_margin()          - auto_generate_bundles()     │
│  - determine_shipping_policy() - 시리즈별 그룹화              │
└────────┬────────────────────────────────────────────────────┘
         │ Analysis Results
         ↓
┌─────────────────────────────────────────────────────────────┐
│                   DISTRIBUTION LAYER                         │
├─────────────────────────────────────────────────────────────┤
│  run_pipeline.py Stage 5                                     │
│  - 5개 계정 라운드로빈 분산                                    │
│  - DB 레벨 중복 체크 (listings 테이블)                        │
│  - WING API 동기화 데이터 기반 중복 필터링                     │
└────────┬──────────────────────┬─────────────────────────────┘
         │                      │
         ↓                      ↓
┌────────────────────┐  ┌───────────────────────────┐
│   CSV EXPORT       │  │   WING API UPLOAD          │
│   (Phase 1)        │  │   (Phase 2) ← 현재        │
├────────────────────┤  ├───────────────────────────┤
│  CoupangCSVGen     │  │  CoupangAPIUploader        │
│  - 113컬럼 V4.5    │  │  - build_product_payload() │
│  - UTF-8-sig       │  │  - upload_product()        │
│  - 계정별 CSV      │  │  - upload_batch()          │
└────────┬───────────┘  │  - 카테고리 추천           │
         │              │  - 고시정보/속성 자동 생성  │
         ↓              └───────────┬───────────────┘
┌────────────────────┐              │
│  output/*.csv      │              ↓
│  (수동 업로드)     │      ┌───────────────────┐
└────────────────────┘      │  Coupang WING API │
                            │  (자동 등록)      │
                            └───────────────────┘
```

---

## 파이프라인 흐름 (run_pipeline.py)

```
Stage 1: DB 초기화
    ↓ Base.metadata.create_all() + ALTER TABLE 마이그레이션
Stage 2: 출판사/계정 시딩 + WING API 연결 확인
    ↓ 24 출판사 + 5 계정 (API 키 검증)
Stage 3: 알라딘 API 검색
    ↓ 24 출판사 × 50건 = 최대 1,200건
Stage 4: 마진 분석 + 묶음 SKU 생성
    ↓ 단권 마진 계산 + 저마진 도서 묶음
Stage 5: WING API 상품 동기화
    ↓ 5계정 기존 상품 14,972개 listings에 반영
Stage 6: CSV 생성 (+ 향후 API 등록 통합)
    ↓ 중복 제외 후 계정별 CSV
```

---

## WING API 인증 흐름

```
1. Account 모델에서 access_key, secret_key 로드
2. 요청 생성: {method} {path}?{query}
3. HMAC-SHA256 서명:
   message = "{datetime}{method}{path}{query}"
   signature = HMAC-SHA256(secret_key, message)
4. Authorization 헤더:
   "CEA algorithm=HmacSHA256, access-key={key}, signed-date={dt}, signature={sig}"
5. X-EXTENDED-TIMEOUT: 90000 헤더 추가
6. Rate limit: 0.1초 간격 (10 calls/sec)
```

---

## 데이터 흐름 상세

### 1. 수집 단계 (Aladin → DB)

```
Aladin API
    ↓ search_by_keyword("개념원리", max_results=50)
JSON 응답
    ↓ _parse_item() → extract_year() → normalize_title() → extract_series()
Enriched Book Data
    {isbn, title, year, normalized_title, normalized_series, list_price, ...}
    ↓ ISBN 중복 체크 (UNIQUE 제약)
books 테이블
```

### 2. 분석 단계 (books → products + bundle_skus)

```
books + publishers (JOIN)
    ↓ MarginCalculator.analyze_book()
    판매가 = 정가 × 0.9
    공급원가 = 정가 × 공급률
    쿠팡수수료 = 판매가 × 0.11 (실제 0.099)
    순마진 = 판매가 - 공급원가 - 수수료 - 배송비(2000원)
    ↓
    순마진 >= 2000원 → products (status='ready', shipping='free')
    순마진 >= 0원   → products (status='ready', shipping='paid')
    순마진 < 0원    → BundleGenerator → bundle_skus
```

### 3. 동기화 단계 (WING API → DB)

```
CoupangWingClient.list_products(vendorId)
    ↓ nextToken 자동 페이징 (전체 목록)
각 상품에서 ISBN 추출
    ↓ barcode → searchTags → productName 순서
listings 테이블에 upsert
    ↓ (account_id, isbn, coupang_product_id, coupang_status)
14,972개 기존 상품 반영 완료
```

### 4. 등록 단계 (DB → WING API)

```
DB에서 미등록 상품 조회
    ↓ listings에 없는 products
CoupangAPIUploader.build_product_payload()
    ↓ 카테고리 추천 → 고시정보 → 속성 → 이미지 → 검색태그
    ↓ JSON payload 생성
CoupangWingClient.create_product(data)
    ↓ HTTP 200 + code=="SUCCESS" 검증
listings 테이블 업데이트 (coupang_product_id 저장)
```

---

## 중복 방지 메커니즘

### 레벨 1: DB 제약조건
```sql
UNIQUE(account_id, isbn)         -- 같은 계정에 같은 단권 중복 방지
UNIQUE(account_id, bundle_key)   -- 같은 계정에 같은 묶음 중복 방지
```

### 레벨 2: WING API 동기화
```
기존 쿠팡 상품 14,972개를 listings에 반영
→ ISBN 기반으로 "이미 등록된 상품" 식별
→ CSV/API 등록 시 자동 제외
```

### 레벨 3: 분산 시 필터링
```python
# 계정별 이미 등록된 ISBN 조회 후 제외
existing_isbns = {l.isbn for l in account.listings}
available = [p for p in products if p.isbn not in existing_isbns]
```

---

## 주요 컴포넌트

| 컴포넌트 | 파일 | 역할 |
|----------|------|------|
| WING 클라이언트 | `app/api/coupang_wing_client.py` | HMAC 인증, API 호출, Rate limit |
| API 업로더 | `uploaders/coupang_api_uploader.py` | JSON 빌드, 카테고리 추천, 상품 등록 |
| CSV 생성기 | `uploaders/coupang_csv_generator.py` | 113컬럼 CSV V4.5 포맷 |
| 파이프라인 | `scripts/run_pipeline.py` | 6단계 자동화 |
| 상품 동기화 | `scripts/sync_coupang_products.py` | WING API → DB 동기화 |
| 마진 분석 | `analyzers/margin_calculator.py` | 마진 계산 + 배송정책 |
| 묶음 생성 | `analyzers/bundle_generator.py` | 저마진 도서 묶음 |
| 알라딘 크롤러 | `crawlers/aladin_api_crawler.py` | 도서 검색 + 메타데이터 |
| 비즈니스 상수 | `app/constants.py` | 기본값, 계정 매핑, 도서 상수 |

---

## 관련 문서

- [[Dashboard]] - 전체 진행률
- [[파일-구조]] - 디렉토리 구조
- [[Database-Schema-V2]] - DB 스키마
- [[쿠팡-API-연동]] - WING API 상세
- [[Tech-Stack]] - 기술 스택
