# 마진/배송비 계산 공식

#technical #margin #shipping #formula

**상태:** ✅ 확정
**적용 범위:** 전체 시스템 (크롤링 → 분석 → 등록 → 대시보드)
**최종 수정:** 2026-02-06

---

## 핵심 공식

### 1단계: 기본 마진 계산

```
판매가    = 정가 × 0.9              (도서정가제 10% 할인)
공급가    = 정가 × 공급율            (출판사별, 예: 65%)
쿠팡수수료 = 판매가 × 11%            (쿠팡 판매 수수료)
마진      = 판매가 - 공급가 - 수수료   (배송비 제외 순수 상품 마진)
```

### 2단계: 배송정책 판단

배송정책은 **"셀러가 배송비를 부담한다고 가정했을 때"** 의 순마진으로 결정한다.

```
판단기준 = 마진 - 2,300 (택배비)

  ≥ 2,000원  →  무료배송 (free)        : 마진이 충분, 셀러가 배송비 부담 가능
  ≥     0원  →  유료배송 (paid)        : 배송비까지 부담하면 적자, 소비자에게 전가
  <     0원  →  묶음필수 (bundle_required) : 상품 마진 자체가 택배비보다 작음
```

### 3단계: 실제 순마진 (셀러가 가져가는 돈)

| 배송정책 | 실제 순마진 | 설명 |
|---------|-----------|------|
| **무료배송** | 마진 - 2,300 | 셀러가 택배비 2,300원 부담 |
| **유료배송** | **마진** | 소비자가 배송비 2,500원 부담, 셀러 차감 없음 |
| **묶음필수** | 마진 - 2,300 | 단독 판매 시 적자 (음수) |

---

## 상수 정의 (`app/constants.py`)

| 상수 | 값 | 용도 |
|-----|------|------|
| `BOOK_DISCOUNT_RATE` | 0.9 | 도서정가제 할인율 |
| `COUPANG_FEE_RATE` | 0.11 | 쿠팡 판매 수수료율 |
| `DEFAULT_SHIPPING_COST` | 2,300 | 실제 택배비 (원) |
| `FREE_SHIPPING_THRESHOLD` | 2,000 | 무료배송 가능 순마진 기준 (원) |

---

## 계산 예시

### 예시 1: 무료배송 (정가 25,000원, 공급율 65%)

```
판매가    = 25,000 × 0.9  = 22,500원
공급가    = 25,000 × 0.65 = 16,250원
수수료    = 22,500 × 0.11 =  2,475원
마진      = 22,500 - 16,250 - 2,475 = 3,775원

판단기준  = 3,775 - 2,300 = 1,475원 ... 아닌데?
→ 1,475 < 2,000 → 유료배송
```

다시: 정가 30,000원, 공급율 65%

```
판매가    = 30,000 × 0.9  = 27,000원
공급가    = 30,000 × 0.65 = 19,500원
수수료    = 27,000 × 0.11 =  2,970원
마진      = 27,000 - 19,500 - 2,970 = 4,530원

판단기준  = 4,530 - 2,300 = 2,230원
→ 2,230 ≥ 2,000 → ✅ 무료배송
실제 순마진 = 4,530 - 2,300 = 2,230원
```

### 예시 2: 유료배송 (정가 15,300원, 공급율 65%)

```
판매가    = 15,300 × 0.9  = 13,770원
공급가    = 15,300 × 0.65 =  9,945원
수수료    = 13,770 × 0.11 =  1,514원
마진      = 13,770 - 9,945 - 1,514 = 2,311원

판단기준  = 2,311 - 2,300 = 11원
→ 0 ≤ 11 < 2,000 → ✅ 유료배송
실제 순마진 = 2,311원 (소비자가 배송비 부담)
```

### 예시 3: 묶음필수 (정가 8,000원, 공급율 65%)

```
판매가    = 8,000 × 0.9  = 7,200원
공급가    = 8,000 × 0.65 = 5,200원
수수료    = 7,200 × 0.11 =   792원
마진      = 7,200 - 5,200 - 792 = 1,208원

판단기준  = 1,208 - 2,300 = -1,092원
→ -1,092 < 0 → ✅ 묶음필수
실제 순마진 = -1,092원 (단독 판매 시 적자)
```

---

## 시스템 적용 현황

### 적용되는 곳

| 파일 | 함수/위치 | 역할 | 상태 |
|------|----------|------|------|
| `app/models/publisher.py` | `calculate_margin()` | 마진 계산 원본 | ✅ |
| `app/models/publisher.py` | `determine_shipping_policy()` | 배송정책 판단 | ✅ |
| `analyzers/margin_calculator.py` | `analyze_book()` | Publisher 위임 | ✅ |
| `app/models/product.py` | `create_from_book()` | DB 저장 시 Publisher 위임 | ✅ |
| `scripts/run_pipeline.py` | `analyze_and_create_products()` | 파이프라인 Product 생성 | ✅ |
| `dashboard.py` | `_recalc_margin()` | 대시보드 실시간 재계산 | ✅ |
| `uploaders/coupang_api_uploader.py` | `build_product_payload()` | API 등록 시 배송비 매핑 | ✅ |

### 쿠팡 API 매핑

| 배송정책 | deliveryChargeType | deliveryCharge | 소비자 부담 |
|---------|-------------------|----------------|-----------|
| free | `FREE` | 0 | 없음 |
| paid | `NOT_FREE` | 2,500 | 2,500원 |
| bundle_required | `NOT_FREE` | 2,500 | 2,500원 |

---

## 통일된 계산 (publisher.py + dashboard.py)

`publisher.py`의 `calculate_margin()`과 `dashboard.py`의 `_recalc_margin()`은 **동일한 공식**을 사용한다.

```python
# publisher.py — calculate_margin()
margin = sale_price - supply_cost - coupang_fee
worst_net = margin - 2,300

if worst_net >= 2,000:  → free,  net_margin = margin - 2,300
elif worst_net >= 0:    → paid,  net_margin = margin          # 소비자 부담
else:                   → bundle, net_margin = margin - 2,300
```

DB(`products.net_margin`)와 대시보드(`calc_net`) 모두 **배송정책 반영된 실제 수익**을 저장/표시한다.

| 배송정책 | DB `net_margin` | 대시보드 `calc_net` |
|---------|----------------|-------------------|
| free | 마진 - 2,300 | 마진 - 2,300 |
| paid | **마진** | **마진** |
| bundle | 마진 - 2,300 | 마진 - 2,300 |

### 기존 DB 데이터 참고

2026-02-06 이전에 생성된 products는 `net_margin = 마진 - 2,300` (항상)으로 저장되어 있음.
신규 등록 페이지의 "재계산" 기능으로 최신 공식 적용 가능.

---

## 관련 문서

- [[신규-등록-승인-흐름]] - 승인 워크플로우
- [[수동-등록-리디자인]] - 수동 등록 페이지
- [[코드-리뷰-자동화-시스템]] - 전체 시스템 구조
