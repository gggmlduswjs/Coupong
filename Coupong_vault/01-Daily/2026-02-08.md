# 2026년 02월 08일 개발 로그

## 오늘의 작업

---

## 02:45 - 검색 태그 Google 자동완성 기반 2차 일괄 업데이트 완료

- **작업 내용**: Google 자동완성 기반으로 강화된 검색 태그 로직을 전 상품 15,359개에 재적용 완료
  - 성공: 14,723개 (95.9%)
  - 동일(스킵): 62개
  - 실패: 574개
  - 5개 계정 전체 완료: 007-book, 007-ez, 007-bm, 002-bm, big6ceo
  - 실패 원인: 출판사 옵션값 중복(~560건, 상품 메타데이터 결함), 新 특수문자 검색어 형식 오류(~14건)
- **변경 파일**: 쿠팡 WING API를 통한 상품 검색태그 업데이트 (코드 변경 없음)
- **이유**: 자격증/IT/시리즈 상품의 검색 태그 품질 향상 (자격증 5→13개, IT 3→13개, 시리즈 15→20개)

---

## 03:03 - 자동 크롤링+등록 완료

- **검색**: 2831개 도서 검색
- **신규 도서**: 3개 발견
- **Product 생성**: 3개
- **미등록 갭**: 8403개
- **쿠팡 등록**: 성공 0개 / 실패 0개
- **재고동기화**: 가격변경 0개, 재고리필 0개
- **소요시간**: 223.2초

---

## 03:15 - 신규등록 버튼 클릭 무반응 버그 수정

- **작업 내용**: AgGrid 선택이 버튼 클릭 rerun 시 소실되는 문제 수정. `session_state`에 선택 상태 보존하여 버튼 동작 보장
- **변경 파일**: `dashboard.py` (신규 등록 섹션)
- **이유**: `update_on=["selectionChanged"]` 설정으로 버튼 클릭 rerun 시 선택 데이터가 안 전달됨 → `_approved_cnt=0` → 조건 불충족

---

## 03:30 - 신규등록 계정 선택 시 이미 등록된 계정 자동 제외

- **작업 내용**: 선택된 상품 기준으로 계정별 미등록 수 계산, 이미 전체 등록된 계정은 체크 해제. "미등록" 컬럼 추가, 등록 루프에서 이미 등록된 상품-계정 조합 자동 스킵
- **변경 파일**: `dashboard.py` (신규 등록 - 계정 선택 + 등록 루프)
- **이유**: 이미 올라간 계정에 중복 등록 시도 방지

---

## 13:30 - 아이템 위너 모니터링 + 등록 완료 상품 관리

- **작업 내용**: 등록 완료 시 products.status 자동 업데이트, 아이템 위너 추적 시스템 구현
  - 전 계정 등록 완료 시 `products.status = 'uploaded'` → 신규등록 목록에서 자동 제거
  - `listings` 테이블에 `winner_status`, `winner_checked_at`, `item_id` 컬럼 추가
  - `sync_coupang_products.py`의 `_parse_detail_fields()`에 winner 파싱 통합
  - `scripts/sync_item_winner.py` 신규 스크립트 (위너 전용 동기화, --dry-run 지원)
  - 대시보드 상품관리 KPI에 위너/비위너 건수 추가, 상품 목록 그리드에 위너 컬럼(O/X/-) 표시
  - 대시보드에 "위너 확인" 버튼 추가 (계정별 API 호출로 즉시 위너 상태 갱신)
- **변경 파일**: `dashboard.py`, `app/models/listing.py`, `scripts/sync_coupang_products.py`, `scripts/sync_item_winner.py` (신규)
- **이유**: 등록 완료 상품이 신규 등록 목록에 계속 노출되는 문제 해결 + 아이템 위너 여부를 모르면 실제 판매 가능 여부 파악 불가

---

## 14:30 - 신규등록 일괄 등록 UX 개선 (매트릭스 프리뷰)

- **작업 내용**: 계정 체크박스 UI를 제거하고 상품×계정 체크박스 매트릭스(`st.data_editor`)로 교체
  - 이미 등록된 셀 = ✓ (해제해도 변경 없음), 미등록 셀 = ✓ (해제로 제외 가능)
  - 개별 상품-계정 조합 단위로 등록 여부 선택 가능
  - 등록 건수가 체크 상태에 따라 실시간 변동
- **변경 파일**: `dashboard.py` (신규 등록 일괄 등록 섹션, line 1400~1475)
- **이유**: 상품마다 등록된 계정이 다를 때 계정 체크박스 UX가 불투명함 + 특정 계정 제외 불가

---

## 14:00 - SQLite → Turso(libSQL) 클라우드 DB 마이그레이션

- **작업 내용**: Streamlit Cloud 배포를 위해 로컬 SQLite DB를 Turso(libSQL)로 전환. 엔진 팩토리를 `app/database.py`에 중앙화하고, 환경변수/Streamlit secrets 기반 자동 분기 구현
- **변경 파일**: `app/database.py`, `app/config.py`, `dashboard.py`, `scripts/sync_*.py` (7개), `scripts/fill_*.py` (3개), `scripts/auto_crawl.py`, `scripts/fill_prices.py`, `app/services/wing_sync_base.py`, `app/services/exposure_strategy.py`, `requirements.txt`, `.gitignore`, `scripts/migrate_to_turso.py` (신규)
- **이유**: Streamlit Cloud 배포 시 로컬 SQLite DB(137.5MB)가 서버에 없어 대시보드가 작동하지 않음. Turso는 SQLite 포크로 기존 SQL 134개를 수정 없이 사용 가능

---

## 12:45 - 자동 크롤링 데몬 시작

- **모드**: 데몬 (매일 03:00)
- **PID**: 5452

---

## 21:30 - 반품비 2300→2500원 변경 + 기등록 상품 일괄 수정

- **작업 내용**: `DEFAULT_RETURN_CHARGE = 2500` 상수 신설, 배송비(2300)와 반품비(2500) 분리. WING API PUT으로 기등록 135건 전체 반품비 2500원 수정 완료
- **변경 파일**: `app/constants.py` (`DEFAULT_RETURN_CHARGE`, `BOOK_PRODUCT_DEFAULTS`)
- **이유**: 반품 배송비 기본값 2500원 적용

---

## 20:30 - 상품 옵션 속성 파서 전면 개편 + API 일괄 수정

- **작업 내용**: `_parse_subject()` + `_parse_grade()` 전면 보강
  - 학습과목: 영어 어휘(VOCA,보카 등 13개), 수학(연산,구구단,도형), 국어(언어와매체,화법과작문), 전과목(진단평가,배치고사) 키워드 추가
  - 사용학년: "중등 수학 1-1" 같은 학교급+과목+학년 패턴 지원, 고등 과목명(확률과통계,미적분 등)→"고등" 자동 추론, 단독 N학년→초등 추론
  - 파싱 성공률: 33% → 38% (2432개 중 936개 OK)
- **변경 파일**: `uploaders/coupang_api_uploader.py` (`_parse_subject()`, `_parse_grade()`)
- **API 일괄 수정**: WING API PUT으로 업로드 상품 95건 전체 수정 완료 (중복 속성 5건도 해결)
- **중복 방지**: `_dedupe_attributes()` 유틸 추가 — 같은 attributeTypeName 중복 시 비어있지 않은 값 우선 유지
  - `_build_book_attributes()` 반환 시 적용
  - `update_search_tags.py` PUT payload에도 적용
- **이유**: 카테고리 기본 속성과 등록 시 추가 속성이 같은 이름으로 중복되어 PUT 에러 발생

---

## 19:15 - 알라딘API→대시보드 파이프라인 기술 문서 작성

- **작업 내용**: 전체 데이터 흐름(알라딘 크롤링 → Book → Product 마진계산 → 대시보드 표시 → WING API 등록 → Listing) 기술 문서 작성
- **변경 파일**: `Coupong_vault/03-Technical/알라딘API-대시보드-파이프라인.md` (신규)
- **이유**: 시스템 아키텍처 문서화

---

## 18:30 - 신규등록 매트릭스 체크박스 UX 개선

- **작업 내용**: 이미 등록된 계정은 체크박스 대신 ✅ 텍스트 표시, 미등록만 체크박스로 변경. `data_editor` → `st.columns` 기반 수동 레이아웃
- **변경 파일**: `dashboard.py` (신규 등록 매트릭스 섹션, ~line 1400)
- **이유**: 등록됨/미등록 모두 동일한 체크박스로 표시되어 구분 불가

---

## 18:45 - 신규등록 UX 전면 수정 (행 클릭/체크박스/상세보기 분리)

- **작업 내용**: 5가지 수정
  1. AgGrid rerun 시 빈 선택으로 `nr_sel_titles` 덮어쓰지 않도록 수정 (버튼 무반응 해결)
  2. `update_on=["selectionChanged", "cellClicked"]` — 체크박스+행 클릭 모두 감지
  3. `suppressRowClickSelection=True` — 행 클릭이 체크박스에 영향 안 줌
  4. 행 클릭 → `session_state["nr_detail_title"]`에 저장 → 상세보기/수정 폼 표시 (체크박스와 독립)
  5. "선택 초기화" 버튼 추가 + 삭제 시 상세보기 세션 정리
- **변경 파일**: `dashboard.py` (AgGrid 설정, 이벤트 분리, 상세보기 트리거 변경)
- **이유**: 행 클릭=상세보기, 체크박스=등록 선택 완전 분리

---

## 21:10 - 신규등록 체크박스 해제/초기화 버그 수정

- **작업 내용**: 2가지 버그 수정
  1. 체크박스 전체 해제 시 `nr_sel_titles`가 안 비워지는 문제 → `else: nr_sel_titles = []` 분기 추가
  2. "선택 초기화" 버튼 무반응 → AgGrid key에 버전 카운터(`nr_grid_ver`) 추가, 초기화 시 카운터 증가로 AgGrid 인스턴스 강제 재생성
- **변경 파일**: `dashboard.py` (AgGrid key, 선택 해제 로직)
- **이유**: AgGrid 내부 선택 상태가 session_state와 독립적으로 유지되어 rerun 후 다시 복원됨

---

## 14:30 - 아이템 위너 동기화 시도 + API 한계 확인

- **작업 내용**: `sync_item_winner.py`를 전 계정 대상으로 실행 시도
  - dry-run: `get_product()` API 응답에 `winner` 필드가 **존재하지 않음** 확인
  - --force 실행: 007-book 1,050/3,000건까지 처리 → 위너 0, 비위너 0, 미확인 1,050건 (100% unknown)
  - `get_product_partial()` API도 확인 → 배송/반품 정보만 반환, winner 필드 없음
  - 결론: **쿠팡 WING seller_api `get_product()` 엔드포인트는 `winner` 필드를 반환하지 않음**
  - 부수 효과: 1,050건에 대해 `item_id` 값 확보 (이전 0건 → 1,050건)
  - 무의미한 `winner_checked_at` 리셋 완료, `item_id`는 보존
- **변경 파일**: DB만 변경 (코드 변경 없음)
- **이유**: Buy Box(아이템위너) 현황 파악 필요. 단, API 제한으로 불가 → WING 웹(가격관리)에서만 확인 가능

---

## 23:50 - 매출 활성화 전략 DB 분석 스크립트 구현

- **작업 내용**: `scripts/analyze_sales_activation.py` 신규 스크립트 작성. DB 7개 테이블 기반 매출 차이 원인 진단 리포트 자동 생성
  - 7개 분석 항목: 계정별 매출, 배송비 분포, 매출/미매출 비교, 품절 현황, 출판사 믹스, 가격대별 매출, 실행 액션 리스트
  - `--save` 옵션으로 Obsidian 노트 자동 저장
  - `--months N` 옵션으로 분석 기간 조절
- **변경 파일**: `scripts/analyze_sales_activation.py` (신규)
- **이유**: API 위너 조사 불가 → DB 축적 데이터 기반으로 매출 편중(007-ez 81.7%) 원인 분석 자동화

---

## 23:55 - 판매중 리스팅 상품설명 일괄 채우기

- **작업 내용**: 판매중(active) 15,470건 리스팅 중 description 누락 도서 96권을 알라딘 API로 일괄 보완
  - 채움: 30권 (IT자격증, 일반도서 등 알라딘에 설명 있는 것)
  - 설명없음: 66권 (교재/문제집/잡지/세트류 — 알라딘 자체에 설명 없음)
  - 오류: 0건
  - 영향 리스팅: ~150건 (30권 × 5계정)
- **변경 파일**: `scripts/fill_descriptions.py` (신규), `coupang_auto.db` (books.description 업데이트)
- **이유**: 상품설명 누락 시 SEO/전환율 저하 → 매출 영향

---

## 15:33 - 상품 속성(attributes) 일괄 업데이트

- **작업 내용**: "상세내용 참조" 플레이스홀더를 실제 값으로 교체 (사용연도, 학기, 출시년월, 출판사, 저자, 발행언어, ISBN 등 9개 속성)
  - `scripts/update_attributes.py` 신규 생성 — WING API PUT으로 일괄 수정
  - 5개 계정 병렬 실행 결과:
    - 007-book: ~450건 (쿼터 초과 — 검색태그 작업이 선점)
    - 007-ez/007-bm: 1,449건 (쿼터 초과)
    - 002-bm: **2,283건 완료** (315 스킵, 25 실패)
    - big6ceo: 1,647건 (쿼터 초과)
  - **총 ~5,829건 성공**, 실패 ~61건 ("출판사 옵션값" 카테고리 메타 불일치)
  - 내일 쿼터 리셋 후 나머지 ~7,500건 실행 예정
- **변경 파일**: `scripts/update_attributes.py` (신규), 쿠팡 상품 속성 API 업데이트
- **이유**: 카테고리 필터 검색에서 "상세내용 참조" 상품이 노출 안 됨 → 실제 값 입력으로 노출 확대

---

## 00:10 - 상품설명 누락 도서 템플릿 자동 생성

- **작업 내용**: 알라딘 API에 설명이 없는 66권에 대해 카테고리별 템플릿 자동 생성
  - 8가지 분류: magazine, set, math_workbook, workbook, it_cert, exam_prep, textbook, drill, general
  - `fill_descriptions.py --generate` 실행 → 66권 전부 채움
  - 결과: description 누락 311 리스팅 → **0건** (100% 해소)
- **변경 파일**: `scripts/fill_descriptions.py` (템플릿 생성 기능 추가)
- **이유**: 교재/문제집/잡지류는 알라딘 자체에 설명이 없어 템플릿 방식으로 보완

---

## 23:12 - 상품명 최적화 일괄 업데이트 스크립트 구현

- **작업 내용**: `scripts/update_product_names.py` 신규 생성. 기존 상품명에 누락된 메타데이터(연도, 학년, 출판사, 과목, 자격증 약어 등)를 append-only로 추가
  - 도서 유형 3분류: 교재(textbook), 자격증(cert), 일반도서(general) — 유형별 토큰 우선순위 다름
  - `extract_components()` 재사용 (update_search_tags.py)
  - PUT payload 패턴 복제 — sellerProductName + displayProductName + itemName 동시 업데이트
  - 스킵: 80자 이상, bundle, raw_json 없음, 추가 토큰 없음
  - CLI: `--dry-run`, `--account`, `--limit`, `--delay`, `--skip-long`
- **변경 파일**: `scripts/update_product_names.py` (신규)
- **이유**: 리스팅 41%에 연도 없음, 20%에 출판사 없음 → 검색 노출 저하

---

## 15:30 - 거래처별 주문 그룹핑 (발주서) 기능 구현

- **작업 내용**: 출판사→거래처(총판) 매핑 기반 주문 그룹핑 + 세트 분리
  - `app/constants.py`: `DISTRIBUTOR_MAP` (8개 거래처) + `resolve_distributor()`, EBS→일신 추가
  - `SERIES_TO_PUBLISHER` 25개 시리즈→출판사 매핑 + `match_publisher_from_text()` 2-pass 매칭 (23%→95%)
  - `dashboard.py` 탭4 UX 전면 개편: 요약 테이블 → Excel 다운로드(primary 버튼) → 주문목록 직접 표시
  - 세트 분리: "완자+기출픽 세트" → 개별 도서 행으로 분리 (가격 균등 분배)
  - `scripts/export_order_sheets.py`: CLI도 `--no-split` + `match_publisher_from_text` 적용 + DATE() 날짜필터 수정
- **변경 파일**: `app/constants.py`, `dashboard.py`, `scripts/export_order_sheets.py`
- **이유**: 발주서 UX 개선 + 세트물 개별 카운팅 + 출판사 매칭률 향상

---

## 16:00 - 대시보드 재고/배송비 표시 버그 3건 수정

- **작업 내용**: 신규등록 후 대시보드에 재고 10개, 배송비 빈 값으로 표시되는 버그 수정
  1. `DEFAULT_STOCK` 10→1000 변경 (쿠팡 UI 기준)
  2. Listing INSERT 2곳에 `stock_quantity`, `delivery_charge_type`, `delivery_charge`, `free_ship_over_amount` 추가
  3. `sync_coupang_products.py`에서 `maximumBuyCount`(구매제한=1000)를 `stock_quantity`로 잘못 넣는 버그 제거
  4. 기존 DB: 재고=10 → 1000 (593건), 배송유형 NULL → 계산값 (467건) 일괄 수정
- **변경 파일**: `dashboard.py`, `app/constants.py`, `scripts/sync_coupang_products.py`
- **이유**: 쿠팡에서는 정상 표시되는데 대시보드에서 재고/배송비 데이터가 누락됨

---

## 15:00 - 007-bm 부진 원인 종합 분석

- **작업 내용**: DB 16개 분석 쿼리로 5개 계정 비교 분석 수행
- **핵심 발견**:
  1. **매출 격차 극심**: 1월 기준 007-ez 2,400만 vs 007-bm 10.8만 (222배 차이)
  2. **주문 건수**: 최근 14일 007-bm 5건 vs 007-ez 260건 (대부분 0건인 날)
  3. **가격/마진은 거의 동일**: 평균가 18,189원, 공급률 56.4%, 적자 0건
  4. **배송비**: 무료배송 54.6% (007-ez 47.7%보다 오히려 높음)
  5. **같은 상품 겹침**: 605개 공유상품 중 92.2%가 동일 가격
  6. **007-ez 인기상품**: TOP15 중 10개가 007-bm에도 등록됨 → 같은 상품인데 주문이 안 들어옴
  7. **광고비**: 007-ez만 1월 78만원 광고 집행 (ROAS 30배), 007-bm은 광고 0원
  8. **반품**: 007-bm 2건 vs 007-ez 109건 (매출 자체가 없으니 반품도 없음)
- **결론**: 007-bm 부진의 **1차 원인은 광고 부재 + 판매자 점수/노출 순위 열세**, 가격/상품 구성 문제는 아님
- **변경 파일**: 없음 (분석만)

---

## 23:30 - 발주서 Excel 형식 전면 개편 (어머니 형식 맞춤)

- **작업 내용**: 어머니가 수동으로 만드시던 주문서 형식에 맞게 발주서 스크립트 리라이팅
  - **3열 심플 형식**: `도서명 | 출판사 | 주문수량` (기존 9열 → 3열)
  - **같은 도서 합산**: GROUP BY로 동일 도서 수량 집계 (개별 행 → 합산)
  - **DB JOIN 출판사 매칭**: `orders → listings → products → books → publishers` 체인 활용 (54% 정확 매칭) + 텍스트 매칭 fallback
  - **시리즈 매핑 확장**: 마플→이투스, 수학의바이블→이투스, 100발100중/백발백중→에듀원 추가 → 일반 23→18개 감소
  - **세트 분리 개선**: 짧은 파트에 접두사 상속 ("기본+완성" → "자이스토리 영어 독해 기본"/"자이스토리 영어 독해 완성")
  - 시트 구성: 전체 목록 → 요약 → 거래처별(제일/대성/일신/..) → 매핑표
  - 파일명 자동: `주문MMDD.xlsx` (기존: `발주서_거래처별_...xlsx`)
- **변경 파일**: `scripts/export_order_sheets.py`, `dashboard.py` (탭4), `app/constants.py` (SERIES_TO_PUBLISHER 확장)
- **이유**: 어머니가 수동으로 만들던 발주서를 자동화 (주문0209.xlsx 형식 참조)

---
