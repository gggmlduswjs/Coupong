# 2026년 02월 07일 개발 로그

## 오늘의 작업

---

## 14:00 - 배송비 정책 변경: NOT_FREE → CONDITIONAL_FREE

- **작업 내용**: 유료배송 상품의 배송비 타입을 `NOT_FREE`(항상 2,500원)에서 `CONDITIONAL_FREE`(25,000원 이상 무료, 미만 시 2,500원)로 변경
- **변경 파일**: `app/constants.py`, `uploaders/coupang_api_uploader.py`
- **이유**: 조건부 무료배송으로 고객 구매 유도 (25,000원 이상 주문 시 무료배송)

---

## 14:15 - 배송비 2,500원 → 2,300원 통일

- **작업 내용**: 고객 부담 배송비를 실제 택배비(2,300원)와 동일하게 변경. deliveryCharge, deliveryChargeOnReturn, returnCharge 모두 2,300원
- **변경 파일**: `app/constants.py`, `uploaders/coupang_api_uploader.py`, `dashboard.py`
- **이유**: 배송비로 마진 얹는 것 제거, 실비 그대로 반영

---

## 14:30 - 순마진 기준 로직 변경 (>= 2,000원)

- **작업 내용**: 배송정책 판단을 순마진(마진-배송비) >= 2,000원 기준으로 변경. `paid` 중간 티어 제거, `free`(순마진>=2000) / `bundle_required` 2단계로 단순화. 모든 단권상품 CONDITIONAL_FREE 적용
- **변경 파일**: `app/models/publisher.py`, `app/models/product.py`, `uploaders/coupang_api_uploader.py`
- **이유**: 기존 `paid` 티어는 순마진 11~1,967원으로 수익성 부족. 순마진 2,000원 이상만 단권판매 허용

---

## 14:40 - 배송비 하드코딩 제거 + paid 1,140개 DB 마이그레이션

- **작업 내용**: `BOOK_PRODUCT_DEFAULTS`와 dashboard의 배송비 하드코딩(2300)을 `DEFAULT_SHIPPING_COST` 상수 참조로 변경. DB의 기존 paid 상품 1,140개를 `bundle_required`로 업데이트 (status=excluded, can_upload_single=0)
- **변경 파일**: `app/constants.py`, `dashboard.py`, DB `products` 테이블
- **이유**: 배송비 변경 시 한 곳만 수정하면 되도록 상수 일원화. DB 상태를 새 로직과 동기화

---

## 22:30 - 공급률+정가 기반 배송비 규칙 전면 개편

- **작업 내용**: 기존 순마진≥2000 단일 기준 → 공급률+정가 조합별 세분화 배송비 결정으로 변경
  - 55%: ≥15,000 무료 / <15,000 → 2,300원
  - 60%: ≥18,000 무료 / <18,000 → 2,300원
  - 65%: ≥20,500 무료 / 18,000~20,000 → 1,000원 / <18,000 → 2,300원
  - 70%: 18,500~29,000 → 1,000원 / 15,000~18,000 → 2,000원 / 그 외 → 2,300원
  - 73%: 항상 2,300원 (조건부 6만원 무료)
  - can_upload_single: 순마진≥0 (기존 ≥2,000에서 완화)
  - API 업로더: FREE/NOT_FREE/CONDITIONAL_FREE 동적 결정
- **변경 파일**: `app/constants.py`, `app/models/publisher.py`, `app/models/product.py`, `config/publishers.py`, `dashboard.py`, `uploaders/coupang_api_uploader.py`
- **이유**: 공급률별 마진 구조가 다르므로 일률적 기준 대신 세분화된 배송비 정책 적용하여 수익성 최적화

---

## 22:45 - DB 상품 2,600개 새 배송비 규칙으로 마이그레이션

- **작업 내용**: 기존 전체 2,600개 상품의 shipping_cost, net_margin, shipping_policy, can_upload_single, status 재계산
  - 1,768개 업데이트 / 1,637개 제외→업로드가능(ready) 전환
  - 배송정책: free 1,239개 + paid 1,361개 (기존: free 963 + bundle_required 1,637)
  - 셀러 배송비 분포: 0원 1,077개 / 300원 47개 / 1,300원 237개 / 2,300원 1,239개
  - 단권 업로드 가능: 2,600개 전체 (기존 963개 → 2,600개)
- **변경 파일**: `coupang_auto.db` products 테이블
- **이유**: 새 배송비 규칙 적용으로 고객 배송비 부담 분산 → 기존 제외(excluded) 상품 대부분 판매 가능해짐

---

## 23:00 - 유료배송 → 조건부 무료배송 20,000원 적용

- **작업 내용**: 유료배송 상품의 WING API 배송유형을 `NOT_FREE` → `CONDITIONAL_FREE` (20,000원 이상 무료)로 변경. 73%는 기존 60,000원 유지
- **변경 파일**: `app/constants.py` (`determine_delivery_charge_type`, `BOOK_PRODUCT_DEFAULTS`)
- **이유**: 20,000원 이상 주문 시 무료배송 제공으로 고객 구매 유도

---

## 23:30 - 대시보드 상품 관리 판매상태 표시 수정

- **작업 내용**: paused 상태가 대시보드에 안 보이던 문제 수정. KPI/필터/테이블 전부 한글화
- **변경 파일**: `dashboard.py`
- **수정 사항**:
  - KPI: 판매중/판매중지/품절·기타/전체 (기존 sold_out+stopped 합산→0건 표시 버그 수정)
  - 필터: 영문→한글 (판매중, 판매중지, 전체, 대기, 품절, 반려)
  - 테이블 상태 컬럼: active→판매중, paused→판매중지 등 한글 매핑
- **이유**: onSale 동기화 후 paused 3,430건이 KPI/필터에 누락되어 프론트에서 확인 불가

---

## 23:40 - 공급률 62% 전용 배송비 규칙 추가

- **작업 내용**: 62% 규칙 분리 — ≥18,000 무료 / <18,000 → 2,000원 (기존: 65% 규칙으로 묶여 있었음)
- **변경 파일**: `app/constants.py`, `config/publishers.py`
- **이유**: 62% 출판사(에듀원 등 4개)에 별도 배송비 정책 적용. 현재 DB 상품은 0건이므로 마이그레이션 불필요

---

## 24:00 - 노출 전략 대시보드 구현

- **작업 내용**: 쿠팡 알고리즘 최적화를 위한 노출 전략 분석 페이지 추가
  - AdPerformance 모델 (광고 성과 상세: 노출/클릭/전환/ROAS)
  - 광고 보고서 Excel 파서 (상품/키워드/캠페인 자동감지)
  - ExposureStrategyEngine (4요소 가중평균 스코어링 + 액션아이템 + 인사이트)
  - 대시보드 "노출 전략" 페이지 (KPI 5종, 스코어보드, 광고성과, 액션아이템, 기간비교)
- **변경 파일**:
  - `app/models/ad_performance.py` (신규)
  - `app/models/__init__.py` (수정)
  - `scripts/sync_ad_performance.py` (신규)
  - `app/services/exposure_strategy.py` (신규)
  - `dashboard.py` (수정 — 메뉴 + 페이지 추가)
- **이유**: 도서정가제로 가격 경쟁 불가 → 판매속도/광고효율/재고/배송 4요소 종합 분석으로 노출 극대화 전략 수립

---

## 24:30 - 공급률별 조건부 무료배송 기준 차등 적용 + 대시보드 표시 통일

- **작업 내용**: 공급률별 조건부 무료배송 기준금액 차등 적용 (67%→2.5만, 70%→3만, 73%→6만, 그 외→2만). 상품 관리·신규 등록·수동 등록 3곳의 배송비 표시를 모두 통일. 수동 등록에서 출판사 기반 margin_rate 자동 전달하여 업로드 시 올바른 배송비 설정 보장
- **변경 파일**: `app/constants.py`, `dashboard.py`
- **이유**: 기존 "2만↑무료" 하드코딩 → 공급률별 실제 기준 반영으로 정확한 정보 표시 + API 업로드 페이로드 정합성 확보

---

## 03:31 - 자동 크롤링+등록 완료

- **검색**: 2380개 도서 검색
- **신규 도서**: 38개 발견
- **Product 생성**: 38개
- **미등록 갭**: 8682개
- **쿠팡 등록**: 성공 0개 / 실패 0개
- **재고동기화**: 가격변경 0개, 재고리필 0개
- **소요시간**: 1877.2초

---

## 11:15 - 크롤링 제외 필터 추가 + 신규 출판사 15개 활성화·크롤링

- **작업 내용**: 크롤링 시 제외 조건 추가 — 사전/잡지/월간지/자습서/평가문제집(제목·카테고리 키워드) + 정가 5,000원 미만. 비활성 상태였던 신규 출판사 15개 활성화 후 크롤링 실행
- **변경 파일**: `app/constants.py` (CRAWL_MIN_PRICE, CRAWL_EXCLUDE_KEYWORDS), `scripts/franchise_sync.py` (필터 로직), DB publishers 테이블
- **크롤링 결과**: 451개 검색 → 289개 신규 도서 → 289개 Product 생성 (묶음필요 0)
- **활성화 출판사**: 에듀원, 에듀플라자, 디딤돌, 꿈을담는틀, 미래엔에듀, 미래엔, 베스트콜렉션, 진학사, 키출판사, 소마, 씨투엠에듀, 폴리북스, 매스티안, 내신콘서트, 아름다운샘
- **이유**: 수익성 낮은 도서(사전/잡지/5천원 미만) 사전 차단 + 신규 거래처 도서 수집

---

## 11:20 - 기존 DB 상품 제외 필터 소급 적용

- **작업 내용**: 기존 2,927개 상품에 크롤링 제외 필터 소급 적용. 117개 상품을 `status=excluded`, `can_upload_single=False`로 변경
- **내역**: 정가 5,000원 미만 11개 + 키워드 매칭 108개 (사전 51, 잡지 32, 자습서 19, 평가문제집 10, 중복 제거)
- **현황**: ready 2,396 / excluded 117 / old_edition 277 / already_listed 137
- **이유**: 사전·잡지·월간지·자습서·평가문제집·저가도서는 반품률 높고 수익성 부족

---

## 19:00 - 신규 등록 페이지 개편: 편집 기능 확장 + 5계정 일괄등록

- **작업 내용**: 신규 등록 페이지를 단일 계정 의존에서 멀티 계정 일괄등록으로 전면 개편
  - 단일 계정 필수 선택 제거 → WING API 활성 계정 전체 로드
  - 상품 쿼리에서 account_id 필터 제거 + listed_count(등록된 계정 수) JOIN 추가
  - AgGrid에 "등록" 컬럼(N/5) 추가로 계정별 등록 현황 한눈에 파악
  - 수정 폼 3개→8개 필드 확장 (제목/저자/출판사/판매가/정가/배송/이미지URL/설명)
  - books+products 테이블 동시 UPDATE
  - data_editor 기반 계정 선택 + 이중 루프(상품×계정) 일괄등록
- **변경 파일**: `dashboard.py` (신규 등록 섹션 lines 988-1453)
- **이유**: 5개 계정에 동일 상품을 일일이 등록하던 비효율 해소 + 상품 정보 편집 유연성 확보

---

## 21:10 - 상품 등록 페이로드 품질 개선 4건

- **작업 내용**: 쿠팡 WING API 등록 페이로드의 옵션 속성 및 메타데이터 보완
  - 학습과목/사용학년 자동 파싱: 제목에서 과목(수학/국어/영어 등)·학년(초등 6-1, 고3 등) 자동 추출 → 기존 "상세내용 참조" 대체
  - 검색필터 속성 7개 추가: 시리즈명, 사용연도, 학기구분, 도서세트여부, 도서형태, 발행언어, e북포함여부
  - 재고수량(`inventoryCount`) 추가: DEFAULT_STOCK(10) 설정
  - `modelNo`에 ISBN 설정 (기존 빈 문자열)
- **변경 파일**: `uploaders/coupang_api_uploader.py`
- **이유**: 옵션명 "상세내용 참조" 반복 해소 + 검색필터 완성도 향상으로 검색 노출 극대화

---

## 20:55 - 검색 태그 일괄 업데이트 스크립트 구현 + 전체 실행 완료

- **작업 내용**: 1등 상품(완자 화학) 검색어 패턴 분석 후, 전 상품 15,359개에 최적화된 검색태그 자동 생성 + WING API 일괄 업데이트
  - 검색어 패턴: 시리즈+과목/붙여쓰기/역순/학년+과목/연도 조합 등 20종
  - PUT /seller-products (base path + sellerProductId in body + requested=True) → 즉시 승인
  - 가격/배송비 절대 미변경, searchTags만 교체
- **최종 결과**: 성공 14,681 / 스킵 87 / 실패 591 (성공률 96.1%)
  - 5개 계정 전부 완료: 007-book, 007-ez, 007-bm, 002-bm, big6ceo
  - 실패 원인: 출판사 옵션값 중복(~95%), 특수문자 검색어(~3%), 카테고리 null(~2%)
- **변경 파일**: `scripts/update_search_tags.py` (신규)
- **이유**: 기존 상품 대부분 searchTags 빈 배열 → 검색 노출 극대화를 위해 완자 화학(1등 상품)의 검색어 패턴 적용

---

## 13:00 - 비즈니스 인사이트 주간 분석 (2/1~2/7)

- **작업 내용**: 쿠팡 셀러 인사이트 데이터 기반 주간 비즈니스 분석 문서 작성. 전체 지표, 일별 트렌드, 상품별 분석, 실행 추천 7건 도출
- **변경 파일**: `Coupong_vault/02-Features/비즈니스-인사이트-주간분석.md` (신규)
- **이유**: 판매량 +32% 대비 매출 +6%만 성장, 평균 단가 20% 하락 원인 분석 및 광고 예산 충전/고전환 상품 집중 등 액션 플랜 수립

---

## 12:00 - 광고 보고서 파서 실제 쿠팡 보고서 형식 반영

- **작업 내용**: 쿠팡 광고센터 보고서 가이드(y.pdf) 기반으로 파서/모델 전면 업데이트
  - COLUMN_MAP 96개 한글→영문 매핑 (상품광고/브랜드광고/디스플레이광고 전 유형)
  - (1일)/(14일) 기여 기간 접미사 자동 처리 (ATTRIBUTION_BASE 10개, 14일 우선)
  - 신규 필드 11개: bid_type, sales_method, ad_type, option_id, total_quantity, direct_quantity, indirect_quantity, ad_name, placement, creative_id, category
  - 보고서 유형 자동 감지: product/brand/display/keyword/campaign 5종
  - ALTER TABLE 마이그레이션으로 기존 DB 호환
- **변경 파일**: `app/models/ad_performance.py`, `scripts/sync_ad_performance.py`
- **이유**: 실제 쿠팡 광고 보고서 Excel 컬럼명(광고진행 옵션ID, 총주문수(14일) 등)과 파서가 불일치하여 정확한 매핑 필요

---

## 22:00 - 알라딘 API salesPoint 수집 + 판매량순 크롤링 병행

- **작업 내용**: 알라딘 API의 `salesPoint` 필드를 DB에 저장하고, 기존 최신순(PublishTime) 크롤링에 판매량순(SalesPoint) 크롤링을 병행
  - Book 모델에 `sales_point` 컬럼 추가 (INTEGER, indexed)
  - `_parse_item()`에서 `salesPoint` 파싱
  - `crawl_by_publisher()`: PublishTime + SalesPoint 2회 검색 → ISBN 중복 제거 합산
  - 기존 책도 크롤링 시 `sales_point` 자동 갱신
  - 대시보드 신규 등록 그리드에 "판매지수" 컬럼 추가 + 기본 정렬 판매지수 DESC
- **변경 파일**: `app/models/book.py`, `crawlers/aladin_api_crawler.py`, `scripts/franchise_sync.py`, `dashboard.py`
- **이유**: 잘 팔리는 책을 우선 수집하여 등록 우선순위 최적화

---

## 22:30 - 기존 도서 2,927개 salesPoint 일괄 백필

- **작업 내용**: 기존 DB 전체 도서에 대해 알라딘 API로 salesPoint 일괄 업데이트
  - 1단계: 출판사별 SalesPoint 검색 (75개 출판사) → 830개 매칭
  - 2단계: 남은 2,097개 ISBN 개별 조회 → 1,840개 추가 매칭
  - 총 2,695개 업데이트, sales_point > 0: 2,670개 (91.2%)
  - sales_point = 0 남은 257개는 세트상품/절판 등 알라딘 데이터 없음
- **변경 파일**: `scripts/_backfill_sales_point.py` (일회성 스크립트), DB `books.sales_point`
- **이유**: 신규 추가된 sales_point 컬럼에 기존 도서 데이터 채우기

---

## 23:00 - 크롤링 ISBN 프리로드 최적화

- **작업 내용**: `crawl_new_releases`와 `crawl_by_publisher`에서 ISBN별 개별 DB 쿼리를 딕셔너리 프리로드 방식으로 변경
  - 루프 진입 전 `{isbn: sales_point}` 딕셔너리 한 번에 로드
  - 중복 체크: `self.db.query(Book).filter()` → `if isbn in existing_isbn_sp` (O(1))
  - sales_point 갱신: 개별 UPDATE → `sp_updates` 딕셔너리에 수집 후 배치 UPDATE
  - 신규 Book 생성 시 프리로드 딕셔너리에도 추가
- **변경 파일**: `scripts/franchise_sync.py`
- **이유**: 출판사당 200개 × 75개 = 최대 15,000번의 개별 SELECT를 1회 벌크 로드로 대체

---

## 23:30 - 기존 도서 정가 일괄 교정 (160개)

- **작업 내용**: 전체 2,927개 도서의 정가를 알라딘 API 최신값과 비교하여 교정
  - 160개(5.5%) 정가 불일치 발견 및 수정
  - 주요 원인: 일부 출판사 API 응답에서 `priceStandard` 누락 → `priceSales`(할인가) fallback
  - 정가 변경 도서의 Product도 sale_price/net_margin/shipping_policy 재계산
- **변경 파일**: `scripts/_fix_prices.py` (일회성 스크립트), DB `books.list_price` + `products` 재계산
- **이유**: 쎈/RPM 등 주요 도서가 10,000원으로 잘못 저장되어 판매가/마진 계산 오류

---

## 23:45 - 이미지 없는 도서 65개 재조회로 전량 복구 + 근본 원인 수정

- **작업 내용**: `image_url`이 비어 있는 도서 65개를 알라딘 API로 재조회하여 커버 이미지 URL 전량 채움 (65/65 성공). 근본 원인인 `Cover` 파라미터 누락 수정
- **변경 파일**: DB `books.image_url` 65건 업데이트, `crawlers/aladin_api_crawler.py` (3곳에 `"Cover": "Big"` 추가)
- **원인**: 알라딘 API에 `Cover` 파라미터를 안 보내면 기본값(작은 썸네일 또는 빈값)이 반환됨
- **이유**: 앞으로 크롤링 시 커버 이미지 누락 방지

---

## 23:50 - 신규 등록 UI 개선: 전 계정 완료 숨김 + 계정별 등록 현황

- **작업 내용**: 신규 등록 페이지 UX 2가지 개선
  - 전 계정(5/5) 등록 완료 상품 기본 숨김 (체크박스 토글로 표시 가능)
  - "등록" 컬럼에 등록된 계정명 표시: `2/5 (007-book,007-ez)` 형식
  - 상세 보기에도 등록 계정 목록 표시
  - SQL에 `GROUP_CONCAT(DISTINCT a.account_name)` JOIN 추가
- **변경 파일**: `dashboard.py` (신규 등록 섹션)
- **이유**: 5/5 완료 상품이 목록에 불필요하게 노출 + 어떤 계정에 등록됐는지 파악 불가한 UX 문제

---

## 00:15 - 검색 태그 Google 자동완성 기반 품질 강화

- **작업 내용**: 기존 학습서 위주 태그 로직에 자격증/IT/시리즈 인기 검색어 보강
  - Google 자동완성 API로 45개 쿼리 → 260개 인기 검색어 수집
  - `CERT_ABBREVIATIONS` (16개): 컴퓨터활용능력→컴활, 정보처리기사→정처기 등
  - `IT_KEYWORDS` (13개): 엑셀→Excel/스프레드시트, 파이썬→Python/코딩 등
  - `SERIES_BOOST_TAGS` (8개): 개념원리→rpm/알피엠, 마더텅→빨간책 등
  - `extract_components()`에 cert_name/cert_level/cert_type/it_keywords 추출 추가
  - `generate_search_tags()`에 3단계 추가: (12)자격증 약어 (13)IT키워드 (14)시리즈 부스트
  - 효과: 자격증 5→13개, IT 3→13개, 시리즈 15→19~20개 태그
- **변경 파일**: `scripts/update_search_tags.py`
- **이유**: 기존 태그가 학습서엔 15-20개였지만 자격증(5-8개)/IT(3-5개) 상품은 부족. 실제 검색 패턴 반영

---

## 00:45 - Supabase 마이그레이션 UPSERT 옵션 추가 (23505 중복 PK 대응)

- **작업 내용**: 재실행 시 `Key (id)=(...) already exists`(23505) 방지를 위해 `--upsert` 옵션 추가
  - PostgREST `Prefer: resolution=ignore-duplicates` + `on_conflict=id`로 ON CONFLICT (id) DO NOTHING 동작
  - `--upsert` 시 `clear_table()` 스킵, 이미 있는 id는 스킵하고 누락분만 INSERT
  - `supabase_request()`에 `prefer_upsert` 인자, `migrate_table()`에 `use_upsert` 인자 추가
- **변경 파일**: `scripts/migrate_to_supabase.py`
- **이유**: 1차 마이그레이션 후 일부 실패 시 재실행하면 중복 PK로 막히는 상황 해결. UPSERT로 누락 데이터만 안전히 채움

---

## 01:00 - Supabase 22001(value too long for varchar(20)) 대응

- **작업 내용**: `--upsert` 실행 시 22001 "value too long for type character varying(20)" 발생 → VARCHAR(20)/(10) 컬럼 확장
  - `scripts/supabase_alter_varchar.sql` 추가: listings/orders/return_requests/revenue_history의 VARCHAR(20)·(10) → VARCHAR(50) ALTER 문 (이미 적용된 DB용)
  - `scripts/supabase_schema.sql` 내 동일 컬럼들 VARCHAR(50)으로 수정 (신규 배포용)
- **변경 파일**: `scripts/supabase_alter_varchar.sql`(신규), `scripts/supabase_schema.sql`
- **이유**: API/실데이터에서 20자 초과 값이 들어와 22001 발생. 컬럼 확장으로 재마이그레이션 통과

---
