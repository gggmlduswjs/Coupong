# 2026년 02월 06일 개발 로그

## 오늘의 작업

---

## 23:50 - 쿠팡 데이터 완전 동기화 (가격/대시보드)

- **작업 내용**: listing.sale_price를 쿠팡 실제 가격(coupang_sale_price)으로 동기화 + 대시보드 쿠팡 데이터 직접 표시
- **변경 파일**: DB listings 1,269건 가격 동기화, `dashboard.py`, `scripts/sync_coupang_products.py`
- **DB 수정**: sale_price = coupang_sale_price로 1,269건 업데이트
- **대시보드**: Product 가격 대신 Listing(쿠팡) 가격 직접 표시 (정가/판매가/배송유형/배송비/출판사)
- **sync 수정**: 향후 동기화 시 sale_price를 항상 쿠팡가로 덮어쓰도록 변경
- **이유**: 알라딘 단권 가격과 쿠팡 세트 가격 불일치 (28%, 871건) → 쿠팡 데이터가 진짜

---

## 23:30 - 크롤링 데이터 배송비 재계산 (2,600개 전체)

- **작업 내용**: 공급율 수정 후 전체 products 마진/배송정책 재계산
- **수정 결과**:
  - supply_rate 변경: 2,591개
  - 마진 재계산: 2,600개
  - 배송정책 변경: 1,829개 (NOT_FREE 65개 포함)
  - free 2,129→963 / paid 367→1,140 / bundle 39→497
- **이유**: 공급율이 실제보다 낮게 저장 → 마진 과대계산 → 무료배송 과다 지정 문제 정정

---

## 23:20 - 자동생성 출판사 기본 공급율 35% 버그 수정

- **작업 내용**: 새 출판사 자동생성 시 하드코딩된 margin_rate=35 → config 조회 후 적용으로 수정
- **변경 파일**: `scripts/link_unlinked_listings.py`
- **원인**: 출판사가 DB에 없을 때 `margin_rate=35, supply_rate=0.65`로 하드코딩 생성
- **수정**: `config/publishers.py`의 `get_publisher_info()`로 올바른 공급율 조회, 없으면 65% 기본값

---

## 22:30 - sync_coupang_products.py raw_json 파싱 개선

- **작업 내용**: 쿠팡 API raw_json에서 ISBN, 정가, 출판사 제대로 추출하도록 수정
- **변경 파일**: `scripts/sync_coupang_products.py`
- **수정 내용**:
  - `_extract_isbn()`: items[0].attributes에서 ISBN 추출 (1순위 추가)
  - `_parse_detail_fields()`: ISBN, 출판사, original_price, sale_price 추출 추가
  - Stage 2 적용 로직: 파싱된 ISBN, 가격을 listing에 업데이트
- **이유**: raw_json에 ISBN이 있는데도 추출 못 하고 있던 버그 수정

---

## 22:00 - DB 정합성 대폭 개선 (listings 빈 데이터 채우기)

- **작업 내용**: listings 테이블 빈 데이터를 쿠팡 raw_json + 알라딘 검색으로 채움
- **문제 상황**:
  - listings 15,359개 중 ISBN 9.1%, 정가 91.5%만 채워져 있음
  - products 연결률 9.1%로 마진 분석 불가
- **해결 방법**:
  1. 쿠팡 raw_json에서 ISBN, 정가, 브랜드 추출
  2. 알라딘 상품명 검색으로 ISBN 추가 매칭 (1,343개)
  3. ISBN으로 products 연결 업데이트
- **결과**:
  | 항목 | 이전 | 이후 |
  |------|------|------|
  | ISBN | 9.1% | **60.0%** |
  | products 연결 | 9.1% | **19.7%** |
  | brand | 1.8% | **98.2%** |
  | 정가 | 91.5% | **99.7%** |
- **발견**: 쿠팡 API raw_json의 items[0].attributes에 ISBN이 이미 있었음
- **남은 문제**: ISBN 없는 40% (6,145개)는 비도서/검색 불가 상품

---

## 00:30 - 자동 업로드 사고 분석 및 수정

- **작업 내용**: 무단 자동 업로드 사고 원인 분석 및 긴급 수정
- **문제 상황**:
  - 384개 상품이 무료배송(FREE)으로 쿠팡에 자동 등록됨
  - 사용자가 의도하지 않은 상품(논어, 독서평설 등) 포함
  - 수능특강 77건 단권 주문이 무료배송으로 들어옴
- **원인**:
  - `auto_crawl.py` Step 4에서 `upload_to_account()` 자동 호출
  - `constants.py`의 `deliveryChargeType` 기본값이 `FREE`
- **변경 파일**:
  - `scripts/auto_crawl.py` - Step 4 자동 등록 기능 완전 제거
  - `app/constants.py` - 배송비 기본값 변경 (FREE → NOT_FREE, 0 → 2500)
  - `app/api/coupang_wing_client.py` - delete_product, stop_sale 메서드 추가
- **결과**:
  - 자동 업로드 기능 비활성화
  - 향후 등록은 수동 검토 후에만 가능
- **남은 작업**:
  - 쿠팡 셀러센터에서 384개 상품 배송비 수동 수정 필요

---

## 00:40 - 알라딘 크롤러 가격 오류 수정 (심각)

- **작업 내용**: priceSales(판매가) → priceStandard(정가) 오류 수정 + DB 복구 스크립트 작성
- **문제 상황**:
  - 알라딘 API에서 `priceSales`(이미 10% 할인된 판매가)를 정가로 저장
  - Publisher.calculate_margin()이 다시 10% 할인 → 실제 판매가가 정가의 81%
  - **2,361개 도서 (93%)가 20% 할인된 가격으로 등록됨**
  - 예: 정가 19,000원 도서 → 15,390원에 판매 (3,610원 손해/권)
- **변경 파일**:
  - `crawlers/aladin_api_crawler.py:322-325` - priceStandard 우선 사용으로 변경
  - `scripts/fix_prices.py` - DB 가격 복구 스크립트 생성
- **복구 방법**:
  ```bash
  python scripts/fix_prices.py --dry-run  # 미리보기
  python scripts/fix_prices.py --apply    # 실제 적용
  ```
- **이유**: 도서정가제(정가×0.9)를 이미 할인된 가격에 재적용하여 이중 할인

---

## 01:30 - 쿠팡 등록 상품 가격 수정 (WING API)

- **작업 내용**: 384개 상품의 잘못된 가격을 WING API로 일괄 수정
- **문제 상황**:
  - 이중 할인으로 정가의 81%에 판매되던 상품들
  - 예: 17,100원 → 15,390원 (손해 1,710원/권)
- **수정 결과**:
  - 성공: 382개 (가격 수정 완료)
  - 스킵: 2개 (vendor_item_id 없음)
- **변경 파일**:
  - `scripts/fix_coupang_prices.py` - 가격 수정 스크립트 작성
  - `app/api/coupang_wing_client.py` - update_price 메서드 추가
- **생성 문서**: `Coupong_vault/03-Technical/가격-수정-내역-2026-02-06.md`
- **사용 API**: `PUT /vendor-items/{vendorItemId}/prices/{price}?forceSalePriceUpdate=true`
- **이유**: DB 수정만으로는 쿠팡에 등록된 상품 가격이 반영되지 않음

---

## 01:00 - 코드 리뷰 문서 작성

- **작업 내용**: 자동화 시스템 전체 코드 상세 분석 및 문서화
- **생성 파일**: `Coupong_vault/03-Technical/코드-리뷰-자동화-시스템.md`
- **문서 내용**:
  - `auto_crawl.py` 5단계 실행 흐름 분석
  - `franchise_sync.py` 6개 핵심 메서드 상세 설명
  - `coupang_api_uploader.py` 배송비 설정 로직 분석
  - `constants.py` 기본값 설정 분석
  - 사고 발생 경위 타임라인
  - 향후 안전한 등록 절차 권장사항
- **이유**: 코드 이해 없이 작업하여 사고 발생 → 전체 시스템 이해 필요

---

## 20:40 - 역방향 연결 (listings → books/products)

- **작업 내용**: ISBN 기반 역방향 연결로 DB 정합성 개선
- **문제 상황**:
  - listings 15,359개 중 products 연결이 1,182개(7.7%)만 됨
  - 대부분 products 없이 쿠팡에 직접 등록된 상품들
- **해결 방법**:
  - listings의 ISBN으로 알라딘 API 조회
  - books/products 테이블에 65개 추가
  - listings ↔ products 연결 업데이트
- **결과**:
  - Books: 2,535 → 2,600개 (+65)
  - Products: 2,535 → 2,600개 (+65)
  - listings 연결: 1,182 → 1,401개 (+219, 9.1%)
- **남은 문제**: ISBN 없는 listings 13,958개(90.9%)는 수동 연결 필요

---

## 20:26 - 쿠팡 DB 전체 동기화

- **작업 내용**: WING API로 5개 계정 전체 상품 동기화
- **동기화 결과**:
  - 총 15,359개 상품 조회 (쿠팡 실시간 데이터)
  - 007-book: 2,986개, 007-ez: 3,294개, 007-bm: 3,089개
  - 002-bm: 2,623개, big6ceo: 3,367개
- **DB 연결 현황**:
  - listings ↔ products 연결: 1,182개 (7.7%)
  - products에 없는 listings: 14,177개 (92.3%)
- **결론**: listings 대부분은 마진분석(products) 없이 직접 등록된 상품
- **이유**: 사용자 요청으로 쿠팡 실시간 데이터와 정확한 DB 연결 확인

---

## 21:30 - WING API 클라이언트 메서드 확장 (14개 추가)

- **작업 내용**: 쿠팡 WING API 개발자 문서 22개 기반으로 누락된 메서드 추가
- **변경 파일**: `app/api/coupang_wing_client.py`
- **추가/수정 내용**:
  - 기존 `stop_sale()` 경로 수정 (seller-products → vendor-items) + deprecated 처리
  - 상품 조회: `get_inflow_status`, `get_product_partial`, `approve_product`, `list_products_by_timeframe`, `get_product_history`, `get_product_by_sku`
  - 재고/가격: `get_item_inventory`, `update_original_price`, `stop_item_sale`, `resume_item_sale`
  - 자동생성옵션: `enable_auto_option`, `enable_auto_option_all`, `disable_auto_option`, `disable_auto_option_all`
- **이유**: 상품 관리 자동화 고도화를 위해 WING API 전체 커버리지 확보

---

## 22:30 - 쿠팡 발주서(주문) 관리 시스템 구현

- **작업 내용**: WING API 발주서/배송 관련 12개 API 연동 + 주문 DB 동기화 + 대시보드 주문 관리 페이지
- **변경 파일**:
  - `app/models/order.py` (신규) - Order 모델 (orders 테이블)
  - `app/models/__init__.py` - Order import 추가
  - `app/api/coupang_wing_client.py` - 주문 API 12개 메서드 추가
  - `scripts/sync_orders.py` (신규) - OrderSync 클래스 (발주서 동기화)
  - `dashboard.py` - 주문 관리 페이지 추가 (v3.7)
- **추가된 API 메서드**: get_ordersheets(개선), get_all_ordersheets, get_ordersheet_by_shipment, get_ordersheet_by_order, get_ordersheet_history, acknowledge_ordersheets, upload_invoice, update_invoice, stop_shipment, complete_shipment, cancel_order, complete_long_term_undelivery
- **대시보드 기능**: KPI 4개, 일별 추이 차트, 주문 목록/상태별 분석/배송 관리 3탭
- **이유**: 쿠팡 주문 현황 실시간 모니터링 + 상품준비중/송장업로드/취소 관리 자동화

---

## 23:30 - 상품 관리 페이지 4탭 확장

- **작업 내용**: 기존 상품 관리 페이지를 4개 탭 구조로 확장, WING API 14개 메서드 대시보드 연동
- **변경 파일**: `dashboard.py` (lines 132-361 → 4탭 구조로 교체)
- **탭 구성**:
  - Tab 1 📦 상품 목록: 기존 기능 + 실시간 조회/판매중지·재개/기준가격 수정
  - Tab 2 💰 가격/재고: 일괄 동기화 + 가격 불일치 일괄수정 + 재고 부족 일괄리필
  - Tab 3 📋 등록 현황: 기간별 WING API 조회 + 승인 요청 + 반려 상세
  - Tab 4 📜 상태 이력: 상품별 변경 이력 조회
- **추가 KPI**: WING 등록현황 (전체/승인완료/승인대기/반려) — API 키 있는 계정만
- **연동 API**: get_inflow_status, get_item_inventory, stop_item_sale, resume_item_sale, update_original_price, update_price, update_quantity, list_products_by_timeframe, approve_product, get_product_partial, get_product_history
- **이유**: WING API 메서드 추가 후 대시보드에서 활용할 수 있도록 UI 구현

---

## 02:30 - 신규 등록 승인 흐름 구현

- **작업 내용**: 크롤링된 상품의 관리자 검토/승인 워크플로우 구현
- **변경 파일**:
  - `app/models/product.py` - `registration_status` 컬럼 + `is_pending_review`, `is_approved`, `can_upload` 프로퍼티
  - `scripts/run_pipeline.py` - `_migrate_product_registration_status()` + 업로드 쿼리에 승인 필터
  - `scripts/franchise_sync.py` - `find_gaps()` 갭 분석 쿼리에 승인 필터
  - `dashboard.py` - 신규 등록 페이지 전면 개편 (KPI 4개, 상태 필터, 개별/일괄 승인·거부, 미승인 업로드 차단)
- **DB 마이그레이션**: 기존 2,600개 상품 → `approved`로 설정 (하위 호환)
- **이유**: 자동 업로드 사고 재발 방지 — 관리자 승인 없이 쿠팡 등록 불가하도록 변경

---

## 02:00 - 코드 리팩토링 (4주 스프린트 완료)

- **작업 내용**: 보안/안정성/유지보수성 개선을 위한 대규모 리팩토링
- **변경 파일**:
  - `app/services/wing_sync_base.py` (신규) - SQL 인젝션 방지, 공통 계정 조회
  - `app/services/transaction_manager.py` (신규) - 트랜잭션 원자성 보장
  - `app/services/db_migration.py` (신규) - SQLite 마이그레이션 헬퍼
  - `app/utils/retry.py` (신규) - 지수 백오프 재시도 데코레이터
  - `app/utils/sync_logger.py` (신규) - 동기화 로거 + JSON 리포트
  - `app/utils/validators.py` (신규) - ISBN/가격/상품 검증
  - `scripts/sync_revenue.py` - SQL 인젝션 수정, 예외 처리 개선
  - `scripts/sync_inventory.py` - SQL 인젝션 수정
  - `scripts/sync_settlement.py` - SQL 인젝션 수정
  - `scripts/sync_coupang_products.py` - SQLiteMigrator 적용
  - `scripts/auto_crawl.py` - --confirm 플래그 추가
  - `app/api/coupang_wing_client.py` - 재시도 로직 + 응답 파싱 강화
  - `app/constants.py` - SYNC_CONFIG, TIMEOUT_CONFIG 등 설정 추가
  - `app/models/book.py` - extract_year 버그 수정 ("2학년" → 2002년 방지)
  - `uploaders/coupang_api_uploader.py` - 파일 기반 카테고리 캐시
  - `tests/test_validators.py` (신규) - 검증 로직 테스트
  - `tests/test_sync_base.py` (신규) - SQL 인젝션 방지 테스트
- **주요 개선 사항**:
  - P0 보안: SQL 인젝션 취약점 4개 파일에서 파라미터 바인딩으로 수정
  - P1 안정성: API 재시도 로직(지수 백오프), 중복 코드 제거
  - P2 유지보수성: 입력 검증 모듈, 예외 처리 구체화
  - P3 품질: 테스트 코드, 연도 추출 버그 수정, 영구 캐시
- **이유**: 어제 발생한 자동 업로드 사고 후 전체 코드 품질 개선 필요

---

## 23:50 - 수동 등록 페이지 구현 (dashboard v3.8)

- **작업 내용**: DB에 없는 상품도 직접 입력하여 5개 계정에 한번에 등록할 수 있는 수동 등록 페이지 추가
- **변경 파일**: `dashboard.py` (사이드바 메뉴 + 수동 등록 페이지 ~200줄 + 버전 v3.8)
- **주요 기능**: ISBN 조회(DB/알라딘), 폼 입력, 카테고리 추천 API, 전체/개별 계정 선택, 페이로드 미리보기, 멀티 계정 동시 등록, listings DB 자동 저장
- **이유**: 기존 신규 등록은 DB 상품만 1개 계정씩 가능 → 수동 입력 + 5계정 일괄 등록 필요

---

## 23:00 - Unlinked listings 분석 및 연결 스크립트 작성

- **작업 내용**: ISBN 있는데 products 연결 안 된 6,185개 listings 분석 + 내일용 스크립트 작성
- **분석 결과**:
  - Books 테이블 ISBN (2,420개)와 Unlinked listings ISBN (1,926개)이 **완전히 다름** (중복 0개)
  - 원인: Unlinked listings는 파이프라인 거치지 않고 쿠팡에 직접 등록된 상품
  - 알라딘 API로 1,926개 ISBN 조회해서 books/products 생성 필요
- **문제**: 알라딘 API 일일 한도(5,000회) 초과로 내일까지 대기
- **생성 파일**:
  - `unlinked_isbns.txt` - 조회 필요한 1,926개 ISBN 목록
  - `scripts/link_unlinked_listings.py` - 내일 실행할 연결 스크립트
- **내일 할 일**:
  ```bash
  python scripts/link_unlinked_listings.py
  ```
  - 예상 결과: products 연결률 19.7% → ~60%

---

## 23:15 - 출판사 공급율 수정 (5개 자동생성 출판사 + 이름 변경 2건)

- **작업 내용**: 자동생성 출판사 5개의 잘못된 공급율(35%) 정정 + 출판사 이름 2건 변경 + 시딩 공식 버그 수정
- **변경 파일**: DB publishers 테이블, `scripts/run_pipeline.py`, `config/publishers.py`
- **DB 수정**:
  - 개념원리수학연구소: 35% → 65%
  - 아소미디어(아카데미소프트): 35% → 40%
  - 렉스미디어닷넷: 35% → 40%
  - 이지스에듀(이지스퍼블리싱): 35% → 60%
  - 이투스북: 35% → 65%
  - 이퓨쳐 → 이퓨처 (이름 변경)
  - 씨톡 → 씨투 (이름 변경)
- **코드 수정**:
  - `run_pipeline.py`: 시딩 공식 `(100-margin_rate)/100` → `margin_rate/100` 수정
  - `config/publishers.py`: 수익 계산 공식 수정 + 이름 동기화
- **이유**: 크롤링으로 자동생성된 출판사에 기본값 35%가 적용되어 공급율 오류 발생

---

## 22:18 - 자동 크롤링 데몬 시작

- **모드**: 데몬 (매일 03:00)
- **PID**: 15760

---

## 22:50 - 수동 등록 페이지 리디자인 (5-카드 레이아웃)

- **작업 내용**: 수동 등록 페이지를 쿠팡 셀러센터 스타일 5-카드 섹션으로 전면 리디자인
- **변경 파일**: `dashboard.py` (lines 1115-1365 → 1115-1520, 수동 등록 섹션 전체 교체)
- **변경 사항**:
  - CSS 스타일 주입 (파란 보더 섹션 헤더 + 숫자 뱃지 + 태그 pill)
  - 섹션 1: 카테고리 선택 (최상단 이동, 카테고리명 표시)
  - 섹션 2: 기본 정보 (ISBN 조회 + 입력 필드 하나의 카드로 통합, help 텍스트)
  - 섹션 3: 판매 정보 4열 + 실시간 마진 미리보기 (수수료/배송원가/순마진/할인율 metric)
  - 섹션 4: 이미지+설명 2열 + 자동생성 필드 미리보기 (고시정보/속성/검색태그 pill)
  - 섹션 5: data_editor 계정 테이블 + 검증 요약 + 페이로드 미리보기 + 등록 버튼
- **임포트 추가**: `_build_book_notices`, `_build_book_attributes`, `BOOK_CATEGORY_MAP`
- **이유**: 기존 단순 선형 폼 → 전문적 카드형 단계별 등록 폼으로 UX 개선

---

## 23:30 - 카테고리 API 6종 완전 연동

- **작업 내용**: WING 클라이언트 카테고리 API 3종 추가 + 수동 등록 페이지 카테고리 섹션 전면 개선
- **변경 파일**:
  - `app/api/coupang_wing_client.py` — 3개 신규 메서드 + `recommend_category` 확장 + 경로 수정
  - `dashboard.py` — 섹션 1 카테고리 전면 개편, 섹션 4 동적 메타정보, 섹션 5 자동매칭 확인
- **WING 클라이언트 추가**:
  - `list_all_categories()` — 전체 카테고리 트리 조회
  - `validate_category()` — leaf 카테고리 유효성 검사
  - `check_auto_category_agreed()` — 자동매칭 서비스 동의 확인
  - `recommend_category()` — productDescription/brand/attributes/sellerSkuCode 파라미터 추가
  - `DISPLAY_CATEGORIES_PATH` 경로 수정 (openapi → seller_api/meta)
- **대시보드 개선**:
  - 섹션 1: 2탭 구조 (직접입력+AI추천 / 4단계 드릴다운 카테고리 찾기)
  - 섹션 1: 유효성 검사 버튼 + 메타정보 조회 expander (고시정보/속성/인증/허용상태)
  - 섹션 4: API 메타 우선, 하드코딩 fallback (서적 기본값)
  - 섹션 5: 자동매칭 동의 확인 버튼 + 테이블에 자동매칭 열 추가
- **이유**: 카테고리 API 6종 완전 커버리지로 정확한 카테고리 선택 + 동적 메타정보 표시

---

## 23:10 - 판매상태(onSale) 동기화 + 대시보드 개선

- **작업 내용**: WING API `get_item_inventory`의 `onSale` 필드로 판매중/판매중지 구분 + 대시보드 상품 목록 KPI/필터 개선
- **변경 파일**:
  - `scripts/sync_coupang_products.py` — Stage 2에서 `get_item_inventory` 호출, `onSale` → `coupang_status` (active/paused) 매핑
  - `dashboard.py` — 상품 목록 KPI 4개 추가 (판매중/대기/품절·중지/전체), 기본 필터 active, 신규 등록 테이블에 정가/ISBN/배송비 컬럼 추가
  - `start_auto_crawl.vbs` + Startup `CoupongAutoCrawl.vbs` — `--confirm` 플래그 추가
- **결과**: 002-bm 기준 active 2,097 / paused 526 (쿠팡 셀러센터와 일치)
- **이유**: 기존에는 WING API가 모든 상품을 "승인완료"로만 반환 → 실제 판매상태 구분 불가

---

## 00:10 - 신규 등록 마진 기반 배송비 재계산 테이블

- **작업 내용**: 신규 등록 페이지에서 출판사 supply_rate 기준 마진/배송비 실시간 재계산 + 테이블 표시 + 일괄 DB 적용
- **변경 파일**: `dashboard.py` (신규 등록 섹션)
- **변경 사항**:
  - 쿼리에 `p.supply_rate` 컬럼 추가 (publishers JOIN 대신 products에 저장된 값 사용)
  - `_recalc_margin()` 함수: 정가×0.9 판매가, supply_cost, 수수료 11%, 순마진, 배송정책 자동 판단
  - KPI 5열 확장: "배송비 변경 필요" 건수 표시
  - 재계산 요약 컨테이너: 변경 건수 + 현재→재계산 배송정책 크로스탭 + 일괄 적용 버튼
  - AgGrid 테이블: 공급율/재계산마진/재계산배송/변경(⚠) 4개 컬럼 추가
  - 상세 수정폼: 하드코딩 `0.35` → 실제 `supply_rate` + `COUPANG_FEE_RATE` + `DEFAULT_SHIPPING_COST` 상수 사용
  - 임포트: `BOOK_DISCOUNT_RATE, COUPANG_FEE_RATE, DEFAULT_SHIPPING_COST, FREE_SHIPPING_THRESHOLD` 추가
- **마진 계산 공식**: `순마진 = 판매가(정가×0.9) - 공급가(정가×supply_rate) - 수수료(판매가×11%) - 배송비(2,300)`
- **배송정책 판단**: 순마진 ≥ 2,000 → 무료 / ≥ 0 → 유료 / < 0 → 묶음필수
- **이유**: 공급율 수정 후 기존 데이터의 배송정책이 맞지 않음 → 재계산하여 확인/적용 필요

---

## 00:30 - 마진 계산식 수정 (head 제거 + 유료배송 공식)

- **작업 내용**: 신규 등록 테이블 head(200) 제한 제거 + 유료배송 마진 계산식 수정
- **변경 파일**: `dashboard.py`
- **변경 사항**:
  1. `head(200)` 제거 → 전체 상품 표시
  2. 정렬 변경: `shipping_policy DESC, net_margin ASC` (유료배송 먼저)
  3. 유료배송 마진: `margin + 200` → `margin` (소비자가 배송비 부담하므로 차감 없음)
  4. `_DELIVERY_CHARGE` 미사용 변수 제거
- **수정 전**: 유료배송 순마진 = 마진 + (2,500 - 2,300) = 마진 + 200
- **수정 후**: 유료배송 순마진 = 마진 (배송비 차감 없음)
- **이유**: 유료배송은 소비자가 배송비 부담 → 셀러 마진에서 배송비 계산할 필요 없음

---

## 00:40 - publisher.py 마진 공식 통일

- **작업 내용**: `publisher.py`의 `calculate_margin()` 수정 — 배송정책별 실제 순마진 반환하도록 통일
- **변경 파일**: `app/models/publisher.py`, `Coupong_vault/03-Technical/마진-배송비-계산-공식.md`
- **변경 사항**:
  - `calculate_margin()`: 항상 `margin - 2300` → 배송정책별 실제 순마진 (paid = margin, free/bundle = margin - 2300)
  - `determine_shipping_policy()`: `calculate_margin()` 내부에서 이미 판단 → 결과 위임
  - 반환 dict에 `shipping_policy` 키 추가
- **영향 범위**: product.py, margin_calculator.py, run_pipeline.py 등 모든 호출부가 자동 반영
- **문서 작성**: `마진-배송비-계산-공식.md` 기술 문서 생성
- **이유**: DB와 대시보드의 net_margin 불일치 해소 — 전체 시스템 동일 공식 적용

---

## 01:30 - 신규 등록 페이지 그리드 간소화

- **작업 내용**: 재계산마진→순마진 통합, 중복 컬럼(재계산배송/변경) 제거, KPI 4개로 축소
- **변경 파일**: `dashboard.py` (신규 등록 섹션)
- **이유**: 그리드 컬럼 13개→10개, 재계산 값을 기본 표시값으로 사용하여 UI 간소화

---

## 23:44 - 반품/취소 관리 시스템 구현 (dashboard v4.1)

- **작업 내용**: WING API 반품 7개 API 연동 + ReturnRequest 모델 + 동기화 스크립트 + 대시보드 반품 관리 페이지
- **변경 파일**:
  - `app/models/return_request.py` (신규) — ReturnRequest 모델 (return_requests 테이블, 33개 컬럼)
  - `app/models/__init__.py` — ReturnRequest import 추가
  - `app/api/coupang_wing_client.py` — 반품 API 8개 메서드 추가 (get_return_requests, get_all_return_requests, get_return_request, confirm_return_receipt, approve_return_request, get_return_withdrawals, get_return_withdrawals_by_ids, create_return_invoice)
  - `scripts/sync_returns.py` (신규) — ReturnSync 클래스 (상태별+취소유형 조회, 중복제거, 31일 윈도우)
  - `dashboard.py` — 반품 관리 페이지 추가 (v4.1), KPI 4개, 일별 추이 차트, 4탭 (반품 목록/반품 처리/사유 분석/회수 관리)
- **대시보드 탭 기능**:
  - 탭1 반품 목록: 전체 목록 테이블 (AgGrid, 한글 상태 매핑, CSV 다운로드)
  - 탭2 반품 처리: 입고확인/반품승인 (API 호출 → DB 상태 업데이트)
  - 탭3 사유 분석: 사유별 파이차트, 귀책별 분석, 월별 트렌드
  - 탭4 회수 관리: 택배사 선택 + 운송장 입력 → 회수 송장 API 등록
- **이유**: 반품/취소 요청 자동 동기화 + 대시보드에서 조회·처리 자동화

---

## 01:45 - 상품 관리 페이지 순마진 계산 + 출판사 매칭

- **작업 내용**: 기존 등록 상품에 순마진/공급율 컬럼 추가 + 브랜드→출판사 3단계 매칭
- **변경 파일**: `dashboard.py` (상품 관리 Tab1)
- **매칭 로직**: 1순위 publishers 직접 JOIN → 2순위 브랜드 별칭(61개) → 3순위 ISBN→books→publishers
- **결과**: 매칭률 52% → 72% (11,049/15,359건), 미매칭 28%는 기본 65% 적용
- **이유**: 출판사별 공급율 차이로 순마진이 달라지므로 정확한 매칭 필요

---

## 02:30 - 출판사 15개 추가 + 브랜드 별칭 166개 확장 (매칭율 90.6%)

- **작업 내용**: 사용자 제공 공급율로 15개 신규 출판사 DB/config 등록 + 브랜드 별칭맵 61→166개 확장
- **변경 파일**: `config/publishers.py`, `dashboard.py`, DB publishers 테이블
- **신규 출판사**: 매스티안(55%), 소마/씨투엠에듀(60%), 에듀원/에듀플라자/베스트콜렉션/내신콘서트(62%), 디딤돌/꿈을담는틀/미래엔에듀/미래엔/진학사/키출판사/폴리북스/아름다운샘(65%)
- **매칭율**: 52% → 72% → **90.6%** (13,918/15,356건)
- **미매칭 분석**: 나머지 9.4%(1,438건) 중 84%는 "자체브랜드/상세설명참조/빈값" (구조적 한계)
- **실제 브랜드 매칭율**: 98.9% (브랜드 정보 있는 항목 기준)
- **이유**: 출판사 미등록으로 공급율 0% 또는 기본값 65% 적용되어 순마진 부정확

---

## 03:00 - 세트상품 가격 오류 긴급 복구 (108건)

- **작업 내용**: fix_coupang_prices.py가 세트상품을 단권 가격으로 변경한 사고 → WING API로 전 계정 복구
- **원인**: 세트상품 ISBN이 단권 book과 매칭 → `book.list_price × 0.9`(단권가)로 덮어씀
- **피해 규모**: 95건(1차) + 13건(2차) = 108건, 최대 차이 236,600원(C언어 세트 260,000→23,400)
- **복구 방법**: `original_price × 0.9`(쿠팡 정가 기준)로 WING API 가격 복구
- **복구 결과**: 107건 성공, 1건 스킵(007-ez vid 없음 → 셀러센터 수동 수정 필요)
- **영향 계정**: 007-book, 007-bm, 007-ez, 002-bm (4개 계정)

---

## 03:10 - WING API 전체 안전장치 적용 (4개 Lock)

- **작업 내용**: 스크립트에서 위험 API 일괄 실행을 원천 차단하는 안전장치 구현
- **변경 파일**: `app/constants.py`, `app/api/coupang_wing_client.py`, `uploaders/coupang_api_uploader.py`, `dashboard.py`
- **잠금 4종**:
  - `PRICE_LOCK = True` — 가격 변경 차단 (`update_price`, `update_original_price`, `update_inventory`)
  - `DELETE_LOCK = True` — 상품 삭제 차단 (`delete_product`)
  - `SALE_STOP_LOCK = True` — 판매 중지 차단 (`stop_item_sale`)
  - `REGISTER_LOCK = True` — 상품 등록 차단 (`create_product`)
- **동작**: 스크립트 호출 시 `CoupangWingError` 즉시 발생, 대시보드 개별 조작만 허용 (`dashboard_override=True`)
- **이유**: 가격 일괄 변경 사고 재발 방지 + 삭제/중지/등록도 동일 보호

---
