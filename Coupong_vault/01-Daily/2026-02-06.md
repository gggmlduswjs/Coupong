# 2026년 02월 06일 개발 로그

## 오늘의 작업

---

## 00:30 - 자동 업로드 사고 분석 및 수정

- **작업 내용**: 무단 자동 업로드 사고 원인 분석 및 긴급 수정
- **문제 상황**:
  - 384개 상품이 무료배송(FREE)으로 쿠팡에 자동 등록됨
  - 사용자가 의도하지 않은 상품(논어, 독서평설 등) 포함
  - 수능특강 77건 단권 주문이 무료배송으로 들어옴
- **원인**:
  - `auto_crawl.py` Step 4에서 `upload_to_account()` 자동 호출
  - `constants.py`의 `deliveryChargeType` 기본값이 `FREE`
- **변경 파일**:
  - `scripts/auto_crawl.py` - Step 4 자동 등록 기능 완전 제거
  - `app/constants.py` - 배송비 기본값 변경 (FREE → NOT_FREE, 0 → 2500)
  - `app/api/coupang_wing_client.py` - delete_product, stop_sale 메서드 추가
- **결과**:
  - 자동 업로드 기능 비활성화
  - 향후 등록은 수동 검토 후에만 가능
- **남은 작업**:
  - 쿠팡 셀러센터에서 384개 상품 배송비 수동 수정 필요

---

## 00:40 - 알라딘 크롤러 가격 오류 수정 (심각)

- **작업 내용**: priceSales(판매가) → priceStandard(정가) 오류 수정 + DB 복구 스크립트 작성
- **문제 상황**:
  - 알라딘 API에서 `priceSales`(이미 10% 할인된 판매가)를 정가로 저장
  - Publisher.calculate_margin()이 다시 10% 할인 → 실제 판매가가 정가의 81%
  - **2,361개 도서 (93%)가 20% 할인된 가격으로 등록됨**
  - 예: 정가 19,000원 도서 → 15,390원에 판매 (3,610원 손해/권)
- **변경 파일**:
  - `crawlers/aladin_api_crawler.py:322-325` - priceStandard 우선 사용으로 변경
  - `scripts/fix_prices.py` - DB 가격 복구 스크립트 생성
- **복구 방법**:
  ```bash
  python scripts/fix_prices.py --dry-run  # 미리보기
  python scripts/fix_prices.py --apply    # 실제 적용
  ```
- **이유**: 도서정가제(정가×0.9)를 이미 할인된 가격에 재적용하여 이중 할인

---

## 01:30 - 쿠팡 등록 상품 가격 수정 (WING API)

- **작업 내용**: 384개 상품의 잘못된 가격을 WING API로 일괄 수정
- **문제 상황**:
  - 이중 할인으로 정가의 81%에 판매되던 상품들
  - 예: 17,100원 → 15,390원 (손해 1,710원/권)
- **수정 결과**:
  - 성공: 382개 (가격 수정 완료)
  - 스킵: 2개 (vendor_item_id 없음)
- **변경 파일**:
  - `scripts/fix_coupang_prices.py` - 가격 수정 스크립트 작성
  - `app/api/coupang_wing_client.py` - update_price 메서드 추가
- **생성 문서**: `Coupong_vault/03-Technical/가격-수정-내역-2026-02-06.md`
- **사용 API**: `PUT /vendor-items/{vendorItemId}/prices/{price}?forceSalePriceUpdate=true`
- **이유**: DB 수정만으로는 쿠팡에 등록된 상품 가격이 반영되지 않음

---

## 01:00 - 코드 리뷰 문서 작성

- **작업 내용**: 자동화 시스템 전체 코드 상세 분석 및 문서화
- **생성 파일**: `Coupong_vault/03-Technical/코드-리뷰-자동화-시스템.md`
- **문서 내용**:
  - `auto_crawl.py` 5단계 실행 흐름 분석
  - `franchise_sync.py` 6개 핵심 메서드 상세 설명
  - `coupang_api_uploader.py` 배송비 설정 로직 분석
  - `constants.py` 기본값 설정 분석
  - 사고 발생 경위 타임라인
  - 향후 안전한 등록 절차 권장사항
- **이유**: 코드 이해 없이 작업하여 사고 발생 → 전체 시스템 이해 필요

---

## 02:00 - 코드 리팩토링 (4주 스프린트 완료)

- **작업 내용**: 보안/안정성/유지보수성 개선을 위한 대규모 리팩토링
- **변경 파일**:
  - `app/services/wing_sync_base.py` (신규) - SQL 인젝션 방지, 공통 계정 조회
  - `app/services/transaction_manager.py` (신규) - 트랜잭션 원자성 보장
  - `app/services/db_migration.py` (신규) - SQLite 마이그레이션 헬퍼
  - `app/utils/retry.py` (신규) - 지수 백오프 재시도 데코레이터
  - `app/utils/sync_logger.py` (신규) - 동기화 로거 + JSON 리포트
  - `app/utils/validators.py` (신규) - ISBN/가격/상품 검증
  - `scripts/sync_revenue.py` - SQL 인젝션 수정, 예외 처리 개선
  - `scripts/sync_inventory.py` - SQL 인젝션 수정
  - `scripts/sync_settlement.py` - SQL 인젝션 수정
  - `scripts/sync_coupang_products.py` - SQLiteMigrator 적용
  - `scripts/auto_crawl.py` - --confirm 플래그 추가
  - `app/api/coupang_wing_client.py` - 재시도 로직 + 응답 파싱 강화
  - `app/constants.py` - SYNC_CONFIG, TIMEOUT_CONFIG 등 설정 추가
  - `app/models/book.py` - extract_year 버그 수정 ("2학년" → 2002년 방지)
  - `uploaders/coupang_api_uploader.py` - 파일 기반 카테고리 캐시
  - `tests/test_validators.py` (신규) - 검증 로직 테스트
  - `tests/test_sync_base.py` (신규) - SQL 인젝션 방지 테스트
- **주요 개선 사항**:
  - P0 보안: SQL 인젝션 취약점 4개 파일에서 파라미터 바인딩으로 수정
  - P1 안정성: API 재시도 로직(지수 백오프), 중복 코드 제거
  - P2 유지보수성: 입력 검증 모듈, 예외 처리 구체화
  - P3 품질: 테스트 코드, 연도 추출 버그 수정, 영구 캐시
- **이유**: 어제 발생한 자동 업로드 사고 후 전체 코드 품질 개선 필요

---
