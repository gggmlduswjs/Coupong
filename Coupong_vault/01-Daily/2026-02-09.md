# 2026년 02월 09일 개발 로그

## 오늘의 작업

---

## 14:00 - 상품준비중 API 수정 (WING API 문서 반영)

- **작업 내용**: 쿠팡 WING API 문서 기반으로 상품준비중(acknowledge) 처리 로직 개선
- **변경 파일**: `app/api/coupang_wing_client.py`, `dashboard.py`
- **이유**: API 문서와 일치하도록 vendorId body 포함, 50건 배치 처리, Partial Error 핸들링 추가

### 변경 사항
1. **API Client** (`acknowledge_ordersheets`):
   - `vendorId` body 파라미터 추가 (API 필수)
   - 50건 초과 시 자동 배치 분할
   - 여러 배치 결과 통합 (responseList 합산)

2. **Dashboard 배송관리 탭**:
   - responseCode별 처리 (0=전체성공, 1=부분성공, 99=전체실패)
   - responseList 개별 결과 확인 → 성공한 건만 DB 업데이트
   - 배송지 변경 경고 안내 추가
   - 취소된 주문(canceled=1) 제외
   - 버튼에 실제 건수 표시

---

## 14:20 - 발주서 목록 조회 API v4 → v5 업그레이드

- **작업 내용**: WING 발주서 조회 API를 v4에서 v5로 업그레이드, 가격 Object 파싱 대응
- **변경 파일**: `app/api/coupang_wing_client.py`, `scripts/sync_orders.py`
- **이유**: 공식 API 문서가 v5이며, v5 응답의 가격 필드가 `{currencyCode, units, nanos}` Object 형태

### 변경 사항
1. **API Client** (`get_ordersheets`):
   - 엔드포인트 v4 → v5 변경
   - 날짜 형식에 `+09:00` 타임존 자동 추가 (ISO-8601)

2. **Sync Script** (`sync_orders.py`):
   - `_extract_price()` 헬퍼 추가: v5 Object `{units, nanos}` 또는 v4 plain int 모두 처리
   - salesPrice, orderPrice, discountPrice, shippingPrice 파싱을 `_extract_price()` 사용

---

## 14:30 - 송장업로드 API 수정 (WING API 문서 반영)

- **작업 내용**: 송장업로드 API 엔드포인트/body 구조를 공식 문서와 일치시킴
- **변경 파일**: `app/api/coupang_wing_client.py`, `dashboard.py`
- **이유**: 엔드포인트, body key, 필수 필드가 API 문서와 불일치

### 변경 사항
1. **API Client** (`upload_invoice`):
   - 엔드포인트: `/ordersheets/invoices` → `/orders/invoices`
   - body key: `orderSheetInvoices` → `orderSheetInvoiceApplyDtos`
   - `vendorId` body 추가
   - `splitShipping`, `preSplitShipped`, `estimatedShippingDate` 기본값 자동 설정

2. **Dashboard 송장 업로드**:
   - Partial Error 핸들링 추가 (responseCode/responseList 확인)
   - 성공한 건만 DB 업데이트
   - 버튼에 건수 표시

---

## 17:30 - 주문 관리 UI/UX 전면 리디자인

- **작업 내용**: 주문 관리 페이지를 쿠팡 WING 스타일로 3탭 구조 리디자인
- **변경 파일**: `dashboard.py` (주문 관리 섹션 ~830줄 전면 교체)
- **이유**: 기존 4탭(주문목록/상태분석/배송관리/거래처발주) → 업무 흐름 기반 3탭으로 개편

### 새로운 탭 구조
1. **결제완료 탭**: 5개 계정 ACCEPT 주문 한눈에 보기 + 전체 계정 상품준비중 일괄 처리
2. **상품준비중 탭**: INSTRUCT 주문 목록 + 거래처별 발주서(Excel) + 계정별 송장 업로드
3. **종합 탭**: 전체 주문 목록(필터) + 상태별 분석(차트) + 주문 취소

### 핵심 변경
- 사이드바 계정 의존성 제거 → 탭 내 드롭다운으로 대체(송장/취소)
- 상품준비중 처리: 단일 계정 → 전체 5개 계정 순회 일괄 처리
- 거래처별 발주: 상태 고정 INSTRUCT (상품준비중 탭으로 이동)
- 계정별 건수 breakdown KPI 표시

---

## 22:30 - Supabase 마이그레이션 오류 해결 (listings + orders)

- **작업 내용**: SQLite → Supabase 마이그레이션에서 listings 208행, orders 675행 누락 문제 해결
- **변경 파일**: `scripts/migrate_to_supabase.py`, `scripts/supabase_schema.sql`
- **이유**: 데이터 타입 불일치로 인한 마이그레이션 실패

### 해결한 문제
1. **listings 208행 누락**: isbn `VARCHAR(13)` → `VARCHAR(100)` 확장. 묶음상품 ISBN이 콤마로 연결(27자)되어 잘림 → unique 충돌
2. **orders 675행 누락**: `product_id`, `seller_product_id`가 INTEGER → BIGINT 변경 필요. Supabase에 `public`과 `api` 두 스키마가 존재하여 **양쪽 모두 ALTER** 필요
3. **마이그레이션 스크립트**: isbn 잘림 방지 (13→100)

### 핵심 발견
- Supabase PostgREST는 `api` 스키마를 사용 (public이 아님)
- `NOTIFY pgrst, 'reload schema'`로 스키마 캐시 갱신 필요
- 최종 결과: 16개 테이블 전부 ✓ 일치

---

## 23:45 - 주문 탭 전체 WING API 실시간 전환

- **작업 내용**: 주문 관리 3탭 모두 DB 쿼리 → WING API 실시간 조회로 전환
- **변경 파일**: `dashboard.py` (주문 관리 섹션)
- **이유**: 탭1(결제완료)만 API였고 탭2(상품준비중), 탭3(종합)은 DB 기반 → 일관성 있는 실시간 조회로 통일

### 핵심 변경
1. `_fetch_live_orders()` 확장: 상태, 택배사, 운송장번호, 배송완료일, 취소 여부 등 필드 추가
2. `_fetch_all_live_orders()` 신규: 6개 상태 concat (종합 탭용)
3. 탭2 상품준비중: 3개 섹션(목록/발주서/송장) 모두 API 전환, DB출판사 제거
4. 탭3 종합: KPI/차트/목록/상태분석/배송소요/주문취소 모두 API 전환
5. 송장등록/주문취소 후 DB UPDATE 제거 → 캐시 무효화로 대체
6. `_ord_date_where` SQL변수 → Python `_filter_orders_by_date()` 함수로 전환
7. **버그 수정**: 60일 범위 API 호출 → 32일 제한으로 400 에러 발생 → 30일씩 2구간 분할 호출

---

## 23:55 - Streamlit Cloud Supabase 연결 — SQL 호환성 수정

- **작업 내용**: dashboard.py의 SQLite 전용 SQL을 PostgreSQL 호환으로 수정 (5곳)
- **변경 파일**: `dashboard.py`
- **이유**: Streamlit Cloud 배포 시 Supabase PostgreSQL을 데이터 소스로 사용하기 위한 호환성 확보

### 변경 사항
1. `_is_pg` 플래그 추가 (app.database에서 `_is_postgresql` 임포트)
2. `INSERT OR IGNORE` 2곳 → `INSERT ... ON CONFLICT DO NOTHING` (SQLite/PG 양쪽 호환)
3. `sqlite_master` 쿼리 → `sa_inspect(engine).has_table()` (SQLAlchemy 추상화)
4. `CREATE TABLE IF NOT EXISTS` 3곳 → `if not _is_pg:` 가드 (AUTOINCREMENT 비호환)
5. `SQLiteMigrator` 호출 → `if not _is_pg:` 가드 (PG에 이미 컬럼 존재)

---

## 24:00 - 발주서 도서명 개선 (세트 과목 전파 + 증정 정리)

- **작업 내용**: 세트 분리 시 "완자 고등" 같은 불완전 도서명에 과목 자동 보충, 증정 문구 제거
- **변경 파일**: `dashboard.py` (`_split_set_name`, `_clean_book_name`)
- **이유**: "완자 고등"만으로는 무슨 책인지 알 수 없어 과목명 전파 필요

### 변경 사항
1. **`_split_set_name` 과목 전파**: 레벨 단어(고등/중등/초등)로 끝나는 파트에 다른 파트의 과목 보충
   - "완자 고등+기출픽 지구과학 세트" → ["완자 고등 지구과학", "기출픽 지구과학"]
2. **`_split_set_name` suffix 필터**: 증정/제공/적용 포함 suffix 제거 (키링제공 등)
3. **`_clean_book_name` 증정 패턴**: "물건+물건 증정" 전체 제거, "단어 증정" 제거
   - "완자 통합과학 수첩형메모지+형광펜 증정" → "완자 통합과학"

---

## 03:07 - 자동 크롤링+등록 완료

- **검색**: 2912개 도서 검색
- **신규 도서**: 285개 발견
- **Product 생성**: 285개
- **미등록 갭**: 9297개
- **쿠팡 등록**: 성공 0개 / 실패 0개
- **재고동기화**: 가격변경 0개, 재고리필 0개
- **소요시간**: 472.2초

---
