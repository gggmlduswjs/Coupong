# 반품/취소 관리 시스템

#feature #반품 #취소 #WING-API

**상태:** ✅ 완료
**구현 파일:** `app/models/return_request.py`, `scripts/sync_returns.py`, `dashboard.py`

---

## 개요
쿠팡 WING API 반품/취소 8개 API를 연동하여, 반품·취소 요청을 자동 동기화하고 대시보드에서 조회·처리할 수 있는 시스템.

## 구현 파일

### 모델
- `app/models/return_request.py` — ReturnRequest 모델 (return_requests 테이블, 33개 컬럼)
- UNIQUE(account_id, receipt_id), 3개 인덱스

### WING API 메서드 (8개)
- `get_return_requests()` — 반품/취소 목록 (기간+상태 필터, 페이징)
- `get_all_return_requests()` — 전체 조회 (자동 페이징)
- `get_return_request()` — 단건 조회
- `confirm_return_receipt()` — 입고 확인 (PUT)
- `approve_return_request()` — 반품 승인 (PUT)
- `get_return_withdrawals()` — 철회 이력 (기간별)
- `get_return_withdrawals_by_ids()` — 철회 이력 (접수번호)
- `create_return_invoice()` — 회수 송장 등록 (POST)

### 동기화 스크립트
- `scripts/sync_returns.py` — ReturnSync 클래스
- 상태별 조회 (RU/UC/CC/PR) + 취소유형 별도 조회
- receipt_id 기준 중복 제거
- 31일 윈도우 분할, INSERT OR REPLACE

### 대시보드
- 사이드바 "반품" 메뉴 (v4.1)
- 상단: 계정/기간/상태 필터 + 동기화 버튼
- KPI 4개: 총 건수, 미처리, 완료, 귀책 비율
- 일별 추이 차트 (반품 건수 + 배송비 부담액)
- 4개 탭: 반품 목록, 반품 처리, 사유 분석, 회수 관리

## 핵심 로직

### 반품 상태 흐름
```
RELEASE_STOP_UNCHECKED (출고중지요청)
  → RETURNS_UNCHECKED (반품접수)
    → VENDOR_WAREHOUSE_CONFIRM (입고확인) ← confirm_return_receipt API
      → RETURNS_COMPLETED (반품완료) ← approve_return_request API
```

### 귀책 유형
- CUSTOMER: 고객귀책 (단순변심 등)
- VENDOR: 셀러귀책 (상품불량 등)
- COUPANG/WMS/GENERAL: 기타

### CLI 사용법
```bash
python scripts/sync_returns.py              # 기본 30일
python scripts/sync_returns.py --days 60    # 최근 60일
python scripts/sync_returns.py --account 007-book  # 특정 계정
python scripts/sync_returns.py --status RU         # 특정 상태
```

## 관련 문서
- [[주문-관리-시스템]] — 주문 동기화 (같은 패턴)
- [[WING-API-클라이언트]] — API 클라이언트 전체 메서드
