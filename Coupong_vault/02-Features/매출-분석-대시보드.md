# 매출 분석 대시보드

#feature #revenue #dashboard #wing-api

**상태:** ✅ 완료
**구현 파일:** `dashboard.py`, `scripts/sync_revenue.py`, `app/models/revenue_history.py`

---

## 개요

WING Revenue History API로 5개 계정의 매출 데이터를 수집하고, Streamlit 대시보드에서 매출 추이/계정별 비교/베스트셀러/마진 분석을 제공한다.

## 아키텍처

```
WING Revenue History API
        ↓ (31일 윈도우 분할 조회)
  sync_revenue.py (RevenueSync)
        ↓ (INSERT OR IGNORE)
  revenue_history 테이블 (주문-아이템 단위 원본)
        ↓ (SQL 집계)
  dashboard.py "매출 분석" 페이지
```

## 구현 파일

### 1. `app/models/revenue_history.py`
- `RevenueHistory` SQLAlchemy 모델
- UNIQUE 제약: `(account_id, order_id, vendor_item_id)`
- 인덱스: account+date, recognition_date, listing_id

### 2. `app/api/coupang_wing_client.py`
- `get_revenue_history()` — 단일 페이지 조회
- `get_all_revenue_history()` — 자동 페이징 전체 조회

### 3. `scripts/sync_revenue.py`
- `RevenueSync` 클래스
- `sync_all(months, account_name)` — 전체/특정 계정 동기화
- `_split_date_range()` — 31일 윈도우 분할
- `_match_listing()` — product_id로 listings 매칭
- CLI: `python scripts/sync_revenue.py --months 3 --account 007-book`

### 4. `dashboard.py` — "매출 분석" 페이지
- 기간 선택 (1주/1개월/3개월) + 계정 필터
- 동기화 버튼 (progress bar)
- KPI 카드 5개: 총매출, 주문수, 정산금액, 평균단가, 환불률
- 일별 매출/정산 라인차트
- 계정별 매출 비교 (테이블 + 바차트)
- 출판사별 매출 Top 10 (listing→books 조인)
- 베스트셀러 Top 20 (정산율 포함)
- 광고 투자 우선순위 (주문 2건 이상, 정산율 높은 순)

## DB 스키마

```sql
revenue_history (
    id, account_id, order_id, sale_type,
    sale_date, recognition_date, settlement_date,
    product_id, product_name, vendor_item_id, vendor_item_name,
    sale_price, quantity, coupang_discount, sale_amount,
    seller_discount, service_fee, service_fee_vat, service_fee_ratio,
    settlement_amount, delivery_fee_amount, delivery_fee_settlement,
    listing_id, created_at
)
```

## 관련 문서

- [[쿠팡-API-연동]] - WING API 클라이언트 기반
- [[Database-Schema-V2]] - 기존 DB 구조
- [[시스템-아키텍처]] - 전체 시스템 구조
