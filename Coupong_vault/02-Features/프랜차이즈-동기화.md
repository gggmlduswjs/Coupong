# 프랜차이즈 동기화

#feature #sync #wing-api

**상태:** ✅ 완료
**구현 파일:** `scripts/franchise_sync.py`, `dashboard.py`

---

## 개요

24개 출판사의 2025~2026년 신간을 알라딘 API로 수집하고, 마진 분석 후 5개 쿠팡 계정에 WING API로 등록한다.
계정별 미등록 도서(갭)를 자동으로 메워 커버리지를 높이는 것이 목표.

## 구현 파일

| 파일 | 역할 |
|------|------|
| `scripts/franchise_sync.py` | `FranchiseSync` 엔진 (크롤링→분석→갭→업로드) |
| `crawlers/aladin_api_crawler.py` | 알라딘 키워드 검색 + 출판사 별칭 매칭 |
| `uploaders/coupang_api_uploader.py` | WING API 상품 등록 |
| `dashboard.py` | "신규 등록" 메뉴에서 크롤링/등록 UI |

## FranchiseSync 파이프라인

```
1. crawl_by_publisher()    → 출판사별 알라딘 검색 (최신순, 2025+)
                             별칭 이름으로도 검색, ISBN 중복 체크
                             → Book 테이블 INSERT

2. analyze_products()      → 미처리 Book → 마진 분석
                             → Product 생성 (sale_price, shipping_policy)

3. find_gaps()             → 계정별 미등록 도서 분석
                             전체 products - 계정 listings = 갭

4. upload_to_account()     → CoupangAPIUploader로 WING API 등록
                             → 성공 시 Listing INSERT
```

## 크롤링 로직 상세

### 검색 기준
- **정렬:** `Sort=PublishTime` (최신 출간순)
- **연도 필터:** `year_filter=2025` (2025년 이후만)
- **조기 종료:** 최신순 정렬에서 2025년 이전 도서 만나면 즉시 다음 출판사로
- **출판사당:** 최대 200건 × (원래 이름 + 별칭 수)

### 별칭 검색
```
"씨톡" 출판사 크롤링 시:
  1. "씨톡"으로 검색 → 결과 0건 (알라딘에 "씨톡" 없음)
  2. "씨앤톡"으로 검색 → 결과 67건 (알라딘 실제 이름)
  3. "C&Talk"으로 검색 → 결과 3건 (영문명)
  → ISBN 중복 제거 후 68건 저장
```

### 중복 방지
1. **배치 내:** `seen_isbns = set()` — 같은 크롤링에서 동일 ISBN 방지
2. **DB 체크:** `Book.isbn` UNIQUE 제약 — 이미 저장된 ISBN 스킵

## 갭 분석 로직

### 중복 체크 방식
계정별 이미 등록된 도서를 **ISBN + 상품명** 두 가지로 확인:

```sql
-- 이 계정에 등록 가능한 도서 = 전체 상품 - 이미 등록된 것
WHERE p.status = 'ready' AND p.can_upload_single = 1
  AND p.isbn NOT IN (등록된 ISBN)
  AND b.title NOT IN (등록된 product_name)
```

- ISBN이 NULL인 listings도 `product_name`으로 매칭하여 중복 방지
- 계정마다 등록된 도서가 다르므로 등록 가능 수가 미세하게 다름

## 현황 (2026-02-05)

| 항목 | 수치 |
|------|------|
| 활성 출판사 | 24개 |
| 총 도서 | 1,189권 (2025~2026) |
| 등록 가능 상품 | 1,189개 |
| 쿠팡 계정 | 5개 |
| 기존 listings | 14,974개 (WING API sync) |

## 대시보드 연동

`dashboard.py` "신규 등록" 메뉴:
- 계정 선택 → 해당 계정의 등록 가능 도서 조회
- "알라딘에서 도서 가져오기" → 크롤링 + 마진 분석
- 등록 가능 도서 테이블 → 선택 등록 또는 일괄 등록

## CLI 사용법

```bash
# 갭 분석만
python scripts/franchise_sync.py --gaps-only

# Dry Run (실제 등록 없이 테스트)
python scripts/franchise_sync.py --dry-run

# 전체 동기화 (크롤링 + 분석 + 등록)
python scripts/franchise_sync.py --max-crawl 200
```

## 관련 문서

- [[알라딘-API-크롤러]] - 크롤러 상세 (별칭, 연도 필터, API 파라미터)
- [[쿠팡-API-연동]] - WING API 클라이언트 + 상품 등록
- [[마진-계산기]] - 마진 분석 로직
- [[Database-Schema-V2]] - books, products, listings 테이블
