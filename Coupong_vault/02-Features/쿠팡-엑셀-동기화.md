# 쿠팡 엑셀 동기화

#feature #sync #deprecated

**상태:** ❌ WING API 동기화로 대체됨
**대체된 파일:** `scripts/sync_coupang_products.py` (WING API 기반)

> **참고:** 이 문서는 초기 설계 문서입니다. 엑셀 수동 동기화 대신 **WING API 직접 동기화**를 구현했습니다.
> 최신 동기화 문서는 [[쿠팡-API-연동]]을 참조하세요.

---

## 개요

쿠팡 판매자센터에서 다운로드한 계정별 상품 목록 엑셀(.xlsx)을 DB에 동기화한다. 중복 업로드 방지 + 판매 상태 관리가 목적.

## 문제

현재 파이프라인은 "새 CSV 생성"만 하고, **이미 쿠팡에 올라간 상품을 모른다.** 결과:
- 같은 책을 다시 업로드하려고 CSV에 포함
- 판매중지된 상품을 관리 못함
- 계정별로 뭐가 올라가 있는지 파악 불가

## 엑셀 파일 구조 (쿠팡 Catalog Template Ver.1.2)

| 컬럼 | 위치 | 용도 |
|------|------|------|
| 등록상품ID | [0] | 쿠팡 내부 ID (고유) |
| 등록상품명 | [1] | 상품 제목 |
| 제조사 | [4] | 출판사명 |
| 브랜드 | [5] | 출판사명 (보통 제조사와 동일) |
| 승인상태 | [8] | 승인완료 / 승인대기 |
| 판매상태 | [9] | **판매중** / **판매중지** |
| 노출상품ID | [10] | 검색 노출 ID |
| 검색옵션값1~100 | [29]~[228] | **ISBN이 여기 숨어있음** |
| 모델번호 | [229] | 거의 비어있음 |
| 바코드 | [230] | 거의 비어있음 |

- 시트명: `Template`
- 헤더: Row 4 (0-indexed Row 3)
- 데이터: Row 5부터

## 007bm 계정 분석 결과

| 항목 | 수치 |
|------|------|
| 총 상품 | 3,088개 |
| 판매중 | 1,530개 |
| 판매중지 | 1,558개 |
| ISBN 추출 가능 | 1,661개 (53.8%) |
| ISBN 추출 불가 | 1,427개 (46.2%) |

## ISBN 추출 전략

### 방법 1: 검색옵션값에서 13자리 숫자 (53.8% 커버)

```python
for col in search_option_value_cols:
    val = str(row[col])
    if len(val) == 13 and val.isdigit():
        return val  # ISBN 발견
```

### 방법 2: 상품명 + 출판사로 DB 매칭 (나머지 46.2%)

```python
# DB에서 같은 출판사의 도서 중 제목이 유사한 것 찾기
candidates = db.query(Book).filter(
    Book.publisher_name == row['제조사']
).all()

for book in candidates:
    if fuzzy_match(row['등록상품명'], book.title) >= 0.8:
        return book.isbn
```

### 방법 3: 매칭 실패 → 등록상품ID로만 추적

ISBN도 없고 DB 매칭도 안 되면, 등록상품ID만 저장하고 `isbn=None`으로 등록. 이 경우 중복 체크는 상품명 기반으로.

## 구현 설계

### 파일 규칙

```
data/coupang_exports/
├── 007-book.xlsx
├── 007-ez.xlsx
├── 007-bm.xlsx
├── 002-bm.xlsx
└── big6ceo.xlsx
```

파일명 = 계정명. `data/coupang_exports/` 폴더에 넣으면 자동 인식.

### sync_coupang_excel.py 흐름

```
1. data/coupang_exports/*.xlsx 스캔
2. 파일명에서 계정명 추출
3. 엑셀 파싱 (Template 시트, Row 4 헤더)
4. 각 행에서:
   a. ISBN 추출 시도 (검색옵션값 → DB 매칭 → 실패)
   b. listings 테이블에 upsert:
      - account_id (계정명으로 조회)
      - isbn (추출된 ISBN 또는 None)
      - coupang_product_id = 등록상품ID
      - coupang_status = 판매상태 → 'active' / 'sold_out'
      - product_type = 'single'
5. 결과 리포트 출력
```

### listings 테이블 활용

```sql
-- 이미 있는 건 UPDATE (판매상태 동기화)
-- 없는 건 INSERT (신규 등록)
-- 기준: UNIQUE(account_id, isbn) 또는 UNIQUE(account_id, coupang_product_id)
```

현재 listings에 `coupang_product_id` 컬럼이 이미 있음 → 바로 사용 가능.

### CSV 생성 시 변경

```python
# 기존: ISBN 기준 중복 체크만
# 변경: ISBN + 등록상품ID 둘 다 체크
def is_already_uploaded(isbn, account_id, db):
    return db.query(Listing).filter(
        Listing.account_id == account_id,
        or_(Listing.isbn == isbn, Listing.coupang_product_id != None)
    ).first() is not None
```

## 사용법 (예정)

```bash
# 1. 엑셀 파일을 폴더에 넣기
cp 007bm.xlsx data/coupang_exports/007-bm.xlsx

# 2. 동기화 실행
python scripts/sync_coupang_excel.py

# 3. 특정 계정만
python scripts/sync_coupang_excel.py --account 007-bm

# 4. 결과 확인
# [007-bm] 3,088개 파싱 → ISBN 1,661개 추출 → listings 갱신 완료
# [007-bm] 판매중: 1,530 / 판매중지: 1,558
```

## 우선순위

1. **ISBN 기반 동기화** (53.8%) → 바로 구현 가능
2. **상품명 fuzzy 매칭** (나머지 46.2%) → ISBN 없는 건 처리
3. **판매상태 동기화** → 판매중지 상품 자동 감지
4. **정기 실행** → Phase 2 스케줄러에 통합

## 관련 문서

- [[Dashboard]] - 전체 기능 상태
- [[Database-Schema-V2]] - listings 테이블 구조
- [[코드-정리-계획]] - Phase 1.5 정리 후 구현
