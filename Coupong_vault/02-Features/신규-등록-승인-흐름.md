# 신규 등록 승인 흐름

#feature #approval #registration

**상태:** ✅ 완료
**구현 파일:** `app/models/product.py`, `dashboard.py`, `scripts/run_pipeline.py`, `scripts/franchise_sync.py`

---

## 개요

크롤링된 상품이 자동으로 쿠팡에 등록되는 것을 방지하기 위한 관리자 승인 워크플로우.
신규 상품은 `pending_review` 상태로 생성되며, 관리자가 대시보드에서 검토 후 승인한 상품만 등록 가능.

## 흐름

```
알라딘 크롤링 → 마진 분석 → Product 생성 (pending_review)
                                    ↓
                          대시보드에서 관리자 검토
                                    ↓
                         승인 (approved) / 거부 (rejected)
                                    ↓
                        승인된 상품만 쿠팡 등록 가능
```

## 구현 파일

### 1. `app/models/product.py`
- `registration_status` 컬럼: `pending_review` (기본값), `approved`, `rejected`
- `is_pending_review` 프로퍼티: 검토 대기 여부
- `is_approved` 프로퍼티: 승인 여부
- `can_upload` 프로퍼티: `status == 'ready' AND registration_status == 'approved' AND can_upload_single`

### 2. `scripts/run_pipeline.py`
- `_migrate_product_registration_status()`: SQLite ALTER TABLE 마이그레이션
- `upload_products()`: `Product.registration_status == 'approved'` 필터 추가

### 3. `scripts/franchise_sync.py`
- `find_gaps()`: 갭 분석 시 승인된 상품만 포함

### 4. `dashboard.py` 신규 등록 페이지
- KPI 4개: 등록 가능(승인됨), 검토 대기, 거부됨, 이미 등록됨
- 등록 상태 필터: 전체/검토 대기/승인됨/거부됨
- 그리드에 "등록상태" 컬럼 표시
- 개별 승인/거부 버튼 (행 상세 영역)
- 일괄 승인/거부 버튼 (체크박스 선택 대상)
- 업로드 시 미승인 상품 자동 제외

## DB 마이그레이션

- 기존 상품 2,600개 → `approved`로 자동 설정 (하위 호환)
- 신규 크롤링 상품 → `pending_review`로 생성

## 관련 문서

- [[자동-업로드-사고-분석]] - 이 기능의 배경
- [[코드-리뷰-자동화-시스템]] - 전체 시스템 구조
